Observatory Progress
====================

## Current: Phase 2 Gateway Core COMPLETE (2026-02-22)

### Completed
- [x] Nav redesign: 9 tabs -> 4 primary (Overview, Protocols, Feed, Errors) + More dropdown
- [x] Overview tab: Command + Pipeline + Agents stacked
- [x] SwarmMonitor GenServer (tasks.jsonl, health-check.sh, DAG)
- [x] ProtocolTracker GenServer (cross-protocol message tracing)
- [x] Command view (agent grid, health bar, alerts, detail panel)
- [x] Pipeline view (DAG waves, task table, project selector)
- [x] Protocols view (message flow, channel stats)
- [x] DashboardSwarmHandlers (all event handlers)
- [x] TeamWatcher: preserve cwd, model, color, joined_at fields
- [x] Mailbox.get_stats/0, CommandQueue.get_queue_stats/0
- [x] Supervision tree updated
- [x] JS keyboard shortcuts 1-4 + MoreDropdown hook
- [x] Live test: server starts, pages render, zero runtime errors
- [x] SwarmMonitor discovers memories project from team config

- [x] Feed: segment-based architecture with subagent blocks
  - Investigated real SubagentStart/SubagentStop payloads in Observatory DB (264 events)
  - Discovered: subagent events fire on PARENT session_id with short hash agent_id
  - Rewrote dashboard_feed_helpers.ex: segment_by_spans splits events into parent/subagent segments
  - Rewrote session_group.ex: renders segments with collapsible subagent blocks (cyan-themed)
  - Collapse/expand at both session level AND subagent level (MapSet keys: session_id, "sub:{agent_id}")
- [x] Build: zero warnings

- [x] File split: embed_templates refactor (4 modules -> .ex + .heex)
  - command_components: 535 -> 102 lines + 6 templates
  - pipeline_components: 276 -> 61 lines + 2 templates
  - protocol_components: 272 -> 52 lines + 5 templates
  - session_group: 388 -> 98 lines + 3 templates
- [x] Feed nesting: tool chain component
  - build_segment_timeline/2 interleaves tools + events chronologically
  - Consecutive tools grouped into collapsible chains
  - chain_tool_summary, chain_total_duration, chain_status helpers
  - Recursive rendering: multi-chain -> single-tool children
- [x] Build: zero warnings

- [x] Command view: agents derived from events (not just teams)
  - build_agent_from_events: session_id, model, cwd, status, current_tool
  - Fleet status bar: total nodes, active/idle/ended, project clusters
  - Compact row layout (handles 100+ agents)
  - Agent selection works with event-derived agents
- [x] Feed naming fix: cwd basename instead of "compact" source
- [x] SwarmMonitor: re-discovers projects on each poll cycle (not just startup)
- [x] Verified: SwarmMonitor reads memories tasks.jsonl (8 tasks, 6 waves)
- [x] Build: zero warnings

- [x] Navigation: flat tab bar replacing broken More dropdown
  - All 12 views visible: Overview, Command, Pipeline, Agents, Protocols, Feed, Tasks, Messages, Errors, Analytics, Timeline, Teams
  - Keyboard shortcuts 1-9,0 for first 10 views
  - Removed MoreDropdown JS hook
- [x] Command view: NOC-style cluster hierarchy
  - build_clusters/1: groups agents by project, then by team (swarm)
  - Project cluster cards with health-colored borders
  - Swarm groups (cyan-bordered) within each cluster
  - Standalone agents below swarm groups
  - Scale caps: swarm 10, standalone 20, with overflow indicators
  - agent_row component extracted for reuse
- [x] Message form: shows "To: {name} ({session_id})" target + toast feedback on send
- [x] Build: zero warnings

- [x] Overview: unified control plane (not stacked components)
  - Fleet bar: nodes, errors, messages, tools, task pipeline, protocol stats, health
  - Activity section: recent errors, recent messages, alerts
  - Passes @errors, @messages, @protocol_stats, @active_tasks to command_view
  - Pipeline only shown when active (no empty "add project" noise)
- [x] Collapsible sidebar: toggle button, state persisted in localStorage
- [x] Fixed ArithmeticError: protocol_stats values are nested maps not ints
- [x] Fixed tool_count guard: team-enriched agents may have non-integer tool_count
- [x] Build: zero warnings

- [x] Letta-compatible agent memory system
  - MemoryStore GenServer: 4 ETS tables, disk persistence to ~/.observatory/memory/
  - Three tiers: core blocks (2000 char limit), recall (200 FIFO), archival (500 ETS + disk overflow)
  - 10 MCP tools: read_memory, memory_replace, memory_insert, memory_rethink,
    conversation_search, conversation_search_date, archival_memory_insert,
    archival_memory_search, create_agent, list_agents
  - Block sharing between agents via IDs, read_only protection
  - Memory.compile() renders blocks as XML for system prompt injection
  - ETS memory caps: 100 agents, 1000 blocks, 500 archival/agent in ETS
  - Archival append-only on disk, search falls back to disk when ETS at capacity
  - Smoke tested: all operations verified end-to-end
- [x] Build: zero warnings

- [x] Mode B Pipeline (Monad Method: Define)
  - 12 accepted ADRs -> 6 FRDs (79 FRs) -> 79 UCs with Gherkin scenarios
  - 3 parallel FRD writer agents + 3 parallel UC writer agents
  - Gate 1: FAIL->fixed->PASS (2 frontmatter mismatches)
  - Gate 2: PASS (18 minor notes, non-blocking)
  - Checkpoint: SPECS/checkpoints/1740153600-checkpoint.md
  - All 88 artifact files committed

- [x] Decision-log skill: ADR + Conversation artifact templates, SPECS_HARVESTED output dir
- [x] ADRs 009-012: updated References sections to proper format

- [x] Feed redesign: turn-based conversation grouping (tasks 1-13)
  - build_turns/1: splits events by UserPromptSubmit/Stop boundaries
  - classify_tool/1: research/build/verify/delegate/communicate/think/other
  - group_into_phases/1: groups consecutive same-category tool pairs
  - Inverted collapse: expanded_sessions (collapsed by default, active auto-expand)
  - New templates: conversation_turn.html.heex, activity_phase.html.heex
  - Old segment templates moved to trash
- [x] Build: zero warnings

### Ready for Swarm
- SwarmMonitor active, polling memories/tasks.jsonl every 3s
- Pipeline view has 8 tasks in 6 DAG waves
- Global hooks configured for all 13 event types -> Observatory
- Command view shows agents from events as they appear

- [x] Mode C Pipeline (Monad Method: Build)
  - 7 FRDs -> 5 phases, 24 sections, 77 tasks, 225 subtasks
  - Phase-to-DAG: deterministic section-to-task conversion with dependency detection
  - Implementation specs in SPECS/implementation/

- [x] Phase 1: DecisionLog Schema (DAG run, 4 tasks)
  - lib/observatory/mesh/decision_log.ex (207 lines)
  - 6 inner embedded schemas: Meta, Identity, Cognition, Action, StateDelta, Control
  - Public API: changeset/2, root?/1, major_version/1, put_gateway_entropy_score/2, from_json/1
  - test/observatory/mesh/decision_log_test.exs (36 tests, 0 failures)
  - Workers: 1 Opus + 3 Sonnet (Sonnet handles well-specified schema tasks fine)
  - Commit: 2a10e77

- [x] Phase-to-DAG Script Improvements
  - Fixed jq template: $DONE_WHEN variable instead of hardcoded string (line 648)
  - All 4 phases validated with --dry-run (phases 2-5)
  - All sed replaced with perl -pe (macOS compatibility)
  - pipefail fix: grep || true for zero-match cases
  - Section summary extraction + auto-generated test AC

- [x] Skill Enforcement: /phase-to-dag
  - Rule: ~/.claude/rules/rule-always-phase-to-dag.md (alwaysApply: true)
  - Hook: ~/.claude/hooks/enforce-skill/phase-to-dag-gate.sh (PreToolUse, exit 2 to block)
  - Bypass: PHASE_TO_DAG_SKILL=1 env var prefix (stateless, per-invocation only)
  - Wired in settings.json PreToolUse hooks
  - Tested: direct bash call blocked, skill-invoked call allowed

- [x] Phase 2: Gateway Core (DAG run, 5 tasks)
  - lib/observatory/gateway/schema_interceptor.ex -- validate/1, build_violation_event/3
  - lib/observatory/mesh/entropy_tracker.ex -- stub (Phase 3)
  - lib/observatory_web/controllers/gateway_controller.ex -- POST /gateway/messages (202/422)
  - PubSub: gateway:violations, gateway:messages, gateway:topology
  - Raw payload security: SHA-256 hash only, never logged/stored/broadcast
  - Topology :schema_violation state with 30s clearance timer
  - 65 tests, 0 failures, zero warnings
  - Workers: 5 (worker-1 through worker-5), all Opus

- [x] Phase 3 Gate Validation (pre-DAG)
  - Mode C Gate + ADR Alignment review: 3 warnings, 2 informational findings
  - Fixed all 5: subscription model rewrite, cross-phase warning, zoom/pan task, force-directed algo, FRD-009 return types
  - Checkpoint: SPECS/checkpoints/1771771271-checkpoint.md
  - Conversation: SPECS/conversations/CONV-003-phase3-gate-validation.md
  - MONAD_LESSON_LOG.md: 5 lessons on upstream mode leaks (pending evaluation)

- [x] Phase 3: Topology & Entropy (DAG run, 7 tasks, 4 waves)
  - Team: dag-phase3 (archived)
  - Wave 1: CausalDAG ETS Store (opus) + EntropyTracker Sliding Window (opus)
  - Wave 2: DAG Query API (sonnet) + Canvas Topology Renderer (haiku+sonnet) + Entropy Alerting (pre-satisfied)
  - Wave 3: Entropy PubSub & SchemaInterceptor Integration (sonnet)
  - Wave 4: Final migration + test suite (lead)
  - 113 tests, 0 failures, zero warnings
  - 6 new modules, 2 modified
  - EXP-001: haiku+sonnet pair -- INCONCLUSIVE (needs better stage-2 prompt)
  - New rule: ~/.claude/rules/rule-skill-coordinator.md (outer coordinator protocol)
  - New file: PIPELINE_EXPERIMENTS.md (experiment log)

## Next
- [ ] Phase 4 (next implementation phase)
- [ ] Code quality review of Phase 3 output
- [ ] EXP-002: haiku+sonnet with pre-digested stage-2 prompt
- [ ] Visual verification: open browser, test topology renderer
- [ ] MONAD_LESSON_LOG.md evaluation for upstream skill amendments
- [ ] Remove dead ToolExecutionBlock module + delegate
