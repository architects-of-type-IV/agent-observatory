Observatory Progress
====================

## Current: Swarm Control Center (2026-02-21)

### Completed
- [x] Nav redesign: 9 tabs -> 4 primary (Overview, Protocols, Feed, Errors) + More dropdown
- [x] Overview tab: Command + Pipeline + Agents stacked
- [x] SwarmMonitor GenServer (tasks.jsonl, health-check.sh, DAG)
- [x] ProtocolTracker GenServer (cross-protocol message tracing)
- [x] Command view (agent grid, health bar, alerts, detail panel)
- [x] Pipeline view (DAG waves, task table, project selector)
- [x] Protocols view (message flow, channel stats)
- [x] DashboardSwarmHandlers (all event handlers)
- [x] TeamWatcher: preserve cwd, model, color, joined_at fields
- [x] Mailbox.get_stats/0, CommandQueue.get_queue_stats/0
- [x] Supervision tree updated
- [x] JS keyboard shortcuts 1-4 + MoreDropdown hook
- [x] Live test: server starts, pages render, zero runtime errors
- [x] SwarmMonitor discovers memories project from team config

- [x] Feed: segment-based architecture with subagent blocks
  - Investigated real SubagentStart/SubagentStop payloads in Observatory DB (264 events)
  - Discovered: subagent events fire on PARENT session_id with short hash agent_id
  - Rewrote dashboard_feed_helpers.ex: segment_by_spans splits events into parent/subagent segments
  - Rewrote session_group.ex: renders segments with collapsible subagent blocks (cyan-themed)
  - Collapse/expand at both session level AND subagent level (MapSet keys: session_id, "sub:{agent_id}")
- [x] Build: zero warnings

- [x] File split: embed_templates refactor (4 modules -> .ex + .heex)
  - command_components: 535 -> 102 lines + 6 templates
  - pipeline_components: 276 -> 61 lines + 2 templates
  - protocol_components: 272 -> 52 lines + 5 templates
  - session_group: 388 -> 98 lines + 3 templates
- [x] Feed nesting: tool chain component
  - build_segment_timeline/2 interleaves tools + events chronologically
  - Consecutive tools grouped into collapsible chains
  - chain_tool_summary, chain_total_duration, chain_status helpers
  - Recursive rendering: multi-chain -> single-tool children
- [x] Build: zero warnings

- [x] Command view: agents derived from events (not just teams)
  - build_agent_from_events: session_id, model, cwd, status, current_tool
  - Fleet status bar: total nodes, active/idle/ended, project clusters
  - Compact row layout (handles 100+ agents)
  - Agent selection works with event-derived agents
- [x] Feed naming fix: cwd basename instead of "compact" source
- [x] SwarmMonitor: re-discovers projects on each poll cycle (not just startup)
- [x] Verified: SwarmMonitor reads memories tasks.jsonl (8 tasks, 6 waves)
- [x] Build: zero warnings

- [x] Navigation: flat tab bar replacing broken More dropdown
  - All 12 views visible: Overview, Command, Pipeline, Agents, Protocols, Feed, Tasks, Messages, Errors, Analytics, Timeline, Teams
  - Keyboard shortcuts 1-9,0 for first 10 views
  - Removed MoreDropdown JS hook
- [x] Command view: NOC-style cluster hierarchy
  - build_clusters/1: groups agents by project, then by team (swarm)
  - Project cluster cards with health-colored borders
  - Swarm groups (cyan-bordered) within each cluster
  - Standalone agents below swarm groups
  - Scale caps: swarm 10, standalone 20, with overflow indicators
  - agent_row component extracted for reuse
- [x] Message form: shows "To: {name} ({session_id})" target + toast feedback on send
- [x] Build: zero warnings

- [x] Overview: unified control plane (not stacked components)
  - Fleet bar: nodes, errors, messages, tools, task pipeline, protocol stats, health
  - Activity section: recent errors, recent messages, alerts
  - Passes @errors, @messages, @protocol_stats, @active_tasks to command_view
  - Pipeline only shown when active (no empty "add project" noise)
- [x] Collapsible sidebar: toggle button, state persisted in localStorage
- [x] Fixed ArithmeticError: protocol_stats values are nested maps not ints
- [x] Fixed tool_count guard: team-enriched agents may have non-integer tool_count
- [x] Build: zero warnings

### Ready for Swarm
- SwarmMonitor active, polling memories/tasks.jsonl every 3s
- Pipeline view has 8 tasks in 6 DAG waves
- Global hooks configured for all 13 event types -> Observatory
- Command view shows agents from events as they appear

### Remaining
- [ ] Visual verification: open browser, click through all views
- [ ] Test feed with active agents spawning subagents
- [ ] Test DAG rendering with real pipeline running
- [ ] Remove dead ToolExecutionBlock module + delegate
