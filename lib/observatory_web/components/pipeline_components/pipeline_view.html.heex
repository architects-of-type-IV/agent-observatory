<%
  tasks = @swarm_state.tasks
  dag = @swarm_state.dag
  pipeline = @swarm_state.pipeline
  active_project = @swarm_state.active_project
  projects = @swarm_state.watched_projects
  task_map = Map.new(tasks, &{&1.id, &1})
  critical_set = MapSet.new(dag.critical_path)
%>
<div class="p-4 flex flex-col gap-4 h-full">
  <%!-- Project selector + progress --%>
  <div class="bg-zinc-900/50 border border-zinc-800 rounded-lg p-3">
    <div class="flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <span class="text-xs text-zinc-500">Project:</span>
        <form phx-change="select_project" class="inline">
          <select
            name="project"
            class="bg-zinc-800 border border-zinc-700 rounded px-2 py-1 text-xs text-zinc-300 focus:border-indigo-500 focus:ring-0 focus:outline-none"
          >
            <option :if={map_size(projects) == 0} value="">No projects</option>
            <option :for={{key, _path} <- projects} value={key} selected={key == active_project}>
              {key}
            </option>
          </select>
        </form>
        <button
          phx-click="toggle_add_project"
          class="text-xs text-indigo-400 hover:text-indigo-300"
        >
          {if @show_add_project, do: "Cancel", else: "+ Add"}
        </button>
      </div>

      <div :if={pipeline.total > 0} class="flex items-center gap-3 text-xs text-zinc-500">
        <span class="px-1.5 py-0.5 rounded bg-emerald-500/15 text-emerald-400">
          {pipeline.completed} done
        </span>
        <span class="px-1.5 py-0.5 rounded bg-blue-500/15 text-blue-400">
          {pipeline.in_progress} running
        </span>
        <span class="px-1.5 py-0.5 rounded bg-zinc-700 text-zinc-400">
          {pipeline.pending} pending
        </span>
        <span :if={pipeline.failed > 0} class="px-1.5 py-0.5 rounded bg-red-500/15 text-red-400">
          {pipeline.failed} failed
        </span>
      </div>
    </div>

    <%!-- Add project form --%>
    <form :if={@show_add_project} phx-submit="add_project" class="flex items-center gap-2 mt-2">
      <input
        type="text"
        name="path"
        placeholder="Project path (e.g. /Users/.../project)"
        class="flex-1 bg-zinc-800 border border-zinc-700 rounded px-2 py-1 text-xs text-zinc-300 placeholder-zinc-600 focus:border-indigo-500 focus:ring-0 focus:outline-none"
      />
      <button
        type="submit"
        class="px-2 py-1 bg-indigo-600/20 text-indigo-400 rounded text-xs hover:bg-indigo-600/30 transition"
      >
        Add
      </button>
    </form>
  </div>

  <%= if tasks == [] do %>
    <.empty_state
      title="No pipeline active"
      description="Add a project with a tasks.jsonl to see the DAG visualization"
    />
  <% else %>
    <%!-- DAG Visualization --%>
    <div class="bg-zinc-900/50 border border-zinc-800 rounded-lg p-4 overflow-x-auto flex-1 min-h-0">
      <h3 class="text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-3">
        Dependency Graph
        <span :if={dag.critical_path != []} class="text-zinc-600 normal-case font-normal ml-2">
          Critical path: {length(dag.critical_path)} tasks
        </span>
      </h3>
      <div class="flex gap-6 overflow-x-auto pb-2 min-h-[200px]">
        <div
          :for={{wave, wave_idx} <- Enum.with_index(dag.waves)}
          class="flex flex-col gap-2 min-w-[140px]"
        >
          <div class="text-[10px] text-zinc-600 uppercase tracking-wider mb-1 text-center">
            Wave {wave_idx}
          </div>
          <.dag_node
            :for={task_id <- wave}
            task={Map.get(task_map, task_id)}
            task_id={task_id}
            is_critical={MapSet.member?(critical_set, task_id)}
            is_selected={@selected_dag_task && @selected_dag_task.id == task_id}
          />
        </div>
      </div>
    </div>

    <%!-- Task Table --%>
    <div class="bg-zinc-900/50 border border-zinc-800 rounded-lg overflow-hidden flex-1 min-h-0">
      <div class="overflow-y-auto max-h-[400px]">
        <table class="w-full text-xs">
          <thead class="sticky top-0 bg-zinc-900 z-10">
            <tr class="text-zinc-500 text-left">
              <th class="px-3 py-2 font-medium">ID</th>
              <th class="px-3 py-2 font-medium">Status</th>
              <th class="px-3 py-2 font-medium">Subject</th>
              <th class="px-3 py-2 font-medium">Owner</th>
              <th class="px-3 py-2 font-medium">Priority</th>
              <th class="px-3 py-2 font-medium">Blocked By</th>
              <th class="px-3 py-2 font-medium">Updated</th>
            </tr>
          </thead>
          <tbody>
            <tr
              :for={task <- tasks}
              phx-click="select_dag_node"
              phx-value-id={task.id}
              class={[
                "border-t border-zinc-800/50 hover:bg-zinc-800/40 cursor-pointer transition",
                @selected_dag_task && @selected_dag_task.id == task.id && "bg-zinc-800/60"
              ]}
            >
              <td class="px-3 py-2 font-mono text-zinc-400">{task.id}</td>
              <td class="px-3 py-2">
                <span class={task_badge_class(task.status)}>
                  {task.status}
                </span>
              </td>
              <td class="px-3 py-2 text-zinc-300 max-w-xs truncate">{task.subject}</td>
              <td class="px-3 py-2 text-zinc-400 font-mono">{task.owner}</td>
              <td class="px-3 py-2 text-zinc-500">{task.priority}</td>
              <td class="px-3 py-2 text-zinc-600 font-mono">
                {Enum.join(task.blocked_by, ", ")}
              </td>
              <td class="px-3 py-2 text-zinc-600 font-mono">
                {short_timestamp(task.updated)}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>
</div>
