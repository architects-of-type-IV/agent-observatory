<%
  count = length(@pairs)
  chain_key = "chain:#{List.first(@pairs).tool_use_id}"
  collapsed = MapSet.member?(@collapsed_sessions, chain_key)
%>
<%= if count == 1 do %>
  <%!-- Single tool: collapsible detail --%>
  <% pair = List.first(@pairs) %>
  <% tool_key = "tool:#{pair.tool_use_id}" %>
  <% tool_collapsed = MapSet.member?(@collapsed_sessions, tool_key) %>
  <div class="ml-4 border-l-2 border-zinc-700 pl-3 py-0.5">
    <div
      class="flex items-center gap-2 cursor-pointer select-none hover:bg-zinc-800/30 rounded px-1 -mx-1 py-0.5"
      phx-click="toggle_session_collapse"
      phx-value-session_id={tool_key}
    >
      <span class="text-zinc-600 text-[10px] font-mono w-2 shrink-0">
        {if tool_collapsed, do: "+", else: "-"}
      </span>
      <span class="text-xs font-mono text-indigo-400 shrink-0">{pair.tool_name}</span>
      <%= cond do %>
        <% pair.status == :in_progress -> %>
          <span class="text-xs font-mono text-amber-400 shrink-0">
            {format_duration(DashboardFeedHelpers.elapsed_time_ms(pair.pre, @now))}...
          </span>
        <% pair.status == :success -> %>
          <span class={"text-xs font-mono shrink-0 #{duration_color(pair.duration_ms)}"}>
            {format_duration(pair.duration_ms)}
          </span>
        <% pair.status == :failure -> %>
          <span class="text-xs font-mono text-red-400 shrink-0">FAIL</span>
        <% true -> %>
      <% end %>
      <span class="text-xs text-zinc-500 truncate flex-1 min-w-0">{event_summary(pair.pre)}</span>
      <span class="text-xs font-mono text-zinc-600 shrink-0">{relative_time(pair.pre.inserted_at, @now)}</span>
    </div>

    <div :if={!tool_collapsed} class="mt-0.5 space-y-0.5 ml-4">
      <div
        class={"flex items-center gap-2 px-2 py-0.5 rounded cursor-pointer hover:bg-zinc-800/50 text-xs #{if @selected_event && @selected_event.id == pair.pre.id, do: "bg-zinc-800/80 ring-1 ring-indigo-500/40", else: ""}"}
        phx-click="select_event"
        phx-value-id={pair.pre.id}
      >
        <span class="text-amber-400 font-mono shrink-0">START</span>
        <span class="text-zinc-400 truncate flex-1">{event_summary(pair.pre)}</span>
      </div>
      <div
        :if={pair.post}
        class={"flex items-center gap-2 px-2 py-0.5 rounded cursor-pointer hover:bg-zinc-800/50 text-xs #{if @selected_event && @selected_event.id == pair.post.id, do: "bg-zinc-800/80 ring-1 ring-indigo-500/40", else: ""}"}
        phx-click="select_event"
        phx-value-id={pair.post.id}
      >
        <span class={"font-mono shrink-0 #{if pair.status == :failure, do: "text-red-400", else: "text-emerald-400"}"}>
          {if pair.status == :failure, do: "FAIL", else: "DONE"}
        </span>
        <span class="text-zinc-400 truncate flex-1">{event_summary(pair.post)}</span>
      </div>
    </div>
  </div>
<% else %>
  <%!-- Multi-tool chain: collapsible group with nested tools --%>
  <%
    summary = DashboardFeedHelpers.chain_tool_summary(@pairs)
    total_dur = DashboardFeedHelpers.chain_total_duration(@pairs)
    status = DashboardFeedHelpers.chain_status(@pairs)
    status_color = case status do
      :success -> "text-emerald-500"
      :in_progress -> "text-amber-400"
      :has_failures -> "text-red-400"
      _ -> "text-zinc-500"
    end
  %>
  <div class="ml-4 border-l-2 border-indigo-500/20 pl-3 py-0.5">
    <div
      class="flex items-center gap-2 cursor-pointer select-none hover:bg-zinc-800/30 rounded px-1 -mx-1 py-0.5"
      phx-click="toggle_session_collapse"
      phx-value-session_id={chain_key}
    >
      <span class="text-zinc-600 text-[10px] font-mono w-2 shrink-0">
        {if collapsed, do: "+", else: "-"}
      </span>
      <span class={"text-xs font-mono shrink-0 #{status_color}"}>{count} tools</span>
      <span class="text-[10px] font-mono text-zinc-500 truncate flex-1 min-w-0">{summary}</span>
      <span :if={total_dur} class={"text-xs font-mono shrink-0 #{duration_color(total_dur)}"}>{format_duration(total_dur)}</span>
    </div>

    <div :if={!collapsed} class="space-y-0">
      <.tool_chain
        :for={pair <- @pairs}
        pairs={[pair]}
        selected_event={@selected_event}
        event_notes={@event_notes}
        collapsed_sessions={@collapsed_sessions}
        now={@now}
      />
    </div>
  </div>
<% end %>
