<% expanded = MapSet.member?(@expanded_sessions, @group.session_id) %>
<div class={[
  "rounded-lg overflow-hidden",
  depth_style(@depth),
  if(@group.is_active, do: "ring-1 ring-emerald-500/20", else: "")
]}>
  <%!-- Session Header (always visible, clickable to toggle) --%>
  <div
    class={[
      "px-3 py-2.5 flex flex-wrap items-center gap-x-3 gap-y-1 cursor-pointer select-none",
      if(@group.is_active, do: "bg-zinc-800/80 hover:bg-zinc-800", else: "bg-zinc-900/60 hover:bg-zinc-900/80")
    ]}
    phx-click="toggle_session_collapse"
    phx-value-session_id={@group.session_id}
  >
    <%!-- Collapse indicator --%>
    <span class="text-zinc-600 text-xs font-mono w-3 shrink-0">
      {if expanded, do: "-", else: "+"}
    </span>

    <%!-- Status dot + Agent name --%>
    <div class="flex items-center gap-2">
      <span class={[
        "w-2.5 h-2.5 rounded-full shrink-0",
        if(@group.is_active, do: "bg-emerald-400 animate-pulse", else: "bg-zinc-600")
      ]} />

      <span class="text-sm font-semibold text-zinc-200">
        {agent_display_name(@group)}
      </span>

      <.role_badge role={@group.role} />
    </div>

    <%!-- Session ID --%>
    <span class="text-xs font-mono text-zinc-600" title={@group.session_id}>
      {short_session(@group.session_id)}
    </span>

    <%!-- Model --%>
    <.model_badge :if={@group.model} model={@group.model} />

    <%!-- Permission mode --%>
    <span
      :if={@group.permission_mode}
      class="text-[10px] font-mono px-1.5 py-0.5 rounded bg-zinc-800 text-zinc-500 border border-zinc-700"
    >
      {permission_label(@group.permission_mode)}
    </span>

    <%!-- Source app --%>
    <span :if={@group.source_app} class="text-[10px] font-mono text-zinc-600">
      {String.upcase(@group.source_app || "")}
    </span>

    <span class="flex-1" />

    <%!-- Stats --%>
    <span :if={@group.turn_count > 0} class="text-xs font-mono text-zinc-500">
      {@group.turn_count} turns
    </span>
    <span :if={@group.tool_count > 0} class="text-xs font-mono text-zinc-600">
      {@group.tool_count} tools
    </span>
    <span :if={@group.subagent_count > 0} class="text-xs font-mono text-cyan-500">
      {@group.subagent_count} sub
    </span>

    <%!-- Time range --%>
    <span :if={@group.start_time} class="text-xs font-mono text-zinc-600">
      {format_time(@group.start_time)}
      {if @group.end_time && @group.end_time != @group.start_time, do: "- #{format_time(@group.end_time)}", else: ""}
    </span>

    <%!-- CWD --%>
    <span :if={@group.cwd} class="text-[10px] font-mono text-zinc-700 truncate max-w-[200px]" title={@group.cwd}>
      {abbreviate_cwd(@group.cwd)}
    </span>
  </div>

  <%!-- Collapsible body --%>
  <div :if={expanded}>
    <%!-- Session Start Banner --%>
    <div
      :if={@group.session_start}
      class="px-3 py-1.5 bg-emerald-500/8 border-b border-emerald-500/20 flex items-center gap-3"
    >
      <span class="text-[10px] font-mono font-bold tracking-wider text-emerald-400 uppercase">
        Start
      </span>
      <span class="text-xs font-mono text-zinc-400">
        {format_time(@group.session_start.inserted_at)}
      </span>
      <span :if={@group.model} class="text-xs text-zinc-500">
        {@group.model}
      </span>
      <span :if={@group.cwd} class="text-xs font-mono text-zinc-600 truncate" title={@group.cwd}>
        {abbreviate_cwd(@group.cwd)}
      </span>
    </div>

    <%!-- Render turns --%>
    <div class="space-y-0">
      <.render_item
        :for={item <- @group.turns}
        item={item}
        selected_event={@selected_event}
        event_notes={@event_notes}
        expanded_sessions={@expanded_sessions}
        now={@now}
      />
    </div>

    <%!-- Session End / Stop Banner --%>
    <div
      :if={@group.session_end || @group.stop_event}
      class="px-3 py-1.5 bg-red-500/8 border-t border-red-500/20 flex items-center gap-3"
    >
      <span class="text-[10px] font-mono font-bold tracking-wider text-red-400 uppercase">
        {if @group.session_end, do: "End", else: "Stop"}
      </span>
      <span class="text-xs font-mono text-zinc-400">
        {format_time((@group.session_end || @group.stop_event).inserted_at)}
      </span>
      <span :if={@group.total_duration_ms} class="text-xs text-zinc-500">
        Duration: {format_duration(@group.total_duration_ms)}
      </span>
      <span :if={session_end_reason(@group)} class="text-xs text-zinc-600">
        {session_end_reason(@group)}
      </span>
    </div>

    <%!-- Active indicator --%>
    <div
      :if={@group.is_active && @group.end_time}
      class="px-3 py-1 bg-emerald-500/5 border-t border-emerald-500/10 flex items-center gap-2"
    >
      <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse" />
      <span class="text-[10px] font-mono text-emerald-500">
        Active -- last event {relative_time(@group.end_time, @now)}
      </span>
    </div>
  </div>
</div>
