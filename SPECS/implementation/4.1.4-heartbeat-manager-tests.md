---
type: task
id: "4.1.4"
section_id: "4.1"
title: "HeartbeatManager Tests"
status: pending
governed_by: ["ADR-019"]
parent_uc: ["UC-0260", "UC-0261", "UC-0262", "UC-0263"]
---

# Task 4.1.4: HeartbeatManager Tests

## Goal

Write ExUnit tests covering the GenServer public API, eviction loop, and HTTP endpoint behaviour under valid, invalid, and edge-case inputs.

## Governing Decisions

- ADR-019

## Verification UCs

- UC-0260
- UC-0261
- UC-0262
- UC-0263

## Subtasks

| ID | Title | Done When | Status |
|----|-------|-----------|--------|
| 4.1.4.1 | Write GenServer tests for record_heartbeat returning :ok, duplicate replacement, and downed GenServer raising | mix test test/observatory/gateway/heartbeat_manager_test.exs | pending |
| 4.1.4.2 | Write eviction test manipulating state to set last_seen 100s ago and sending :check_heartbeats | mix test test/observatory/gateway/heartbeat_manager_test.exs | pending |
| 4.1.4.3 | Write HTTP controller tests for valid POST 200, type mismatch 422, missing agent_id 422, and idempotent upsert | mix test test/observatory_web/controllers/heartbeat_controller_test.exs | pending |
