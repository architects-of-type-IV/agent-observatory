---
type: task
id: "4.4.2"
section_id: "4.4"
title: "ETS Buffer and Rewrite Support"
status: pending
governed_by: ["ADR-021"]
parent_uc: ["UC-0272"]
---

# Task 4.4.2: ETS Buffer and Rewrite Support

## Goal

Implement `buffer_message/3` that appends a DecisionLog to the ETS list for `{session_id, agent_id}` (no-op when session is normal). Implement `rewrite/5` that locates the buffered entry matching `original_trace_id` in `meta.trace_id`, replaces its `action.tool_output_summary`, and returns `{:error, :trace_id_not_found_in_buffer}` when no match exists.

## Governing Decisions

- ADR-021

## Verification UCs

- UC-0272

## Subtasks

| ID | Title | Done When | Status |
|----|-------|-----------|--------|
| 4.4.2.1 | Implement buffer_message/3 as GenServer.cast appending to ETS list; no-op when session is :normal | mix compile --warnings-as-errors | pending |
| 4.4.2.2 | Implement rewrite/5 searching buffer by trace_id and returning {:error, :trace_id_not_found_in_buffer} on miss | mix compile --warnings-as-errors | pending |
