---
type: task
id: "2.4.2"
section_id: "2.4"
title: "Post-Validation Message Routing"
status: pending
governed_by: ["ADR-015"]
parent_uc: ["UC-0217"]
---

# Task 2.4.2: Post-Validation Message Routing

## Goal

Complete the success path in `GatewayController.handle_valid/2`. Call `EntropyTracker.record_and_score/2` if `log.cognition` is not `nil`, overwrite `log.cognition.entropy_score` with the computed score, broadcast `{:decision_log, updated_log}` on `"gateway:messages"`, and respond HTTP 202 with `{"status": "accepted", "trace_id": "<log.meta.trace_id>"}`. On broadcast failure, log a warning and still respond 202.

## Governing Decisions

- ADR-015

## Verification UCs

- UC-0217

## Subtasks

| ID | Title | Done When | Status |
|----|-------|-----------|--------|
| 2.4.2.a | Replace placeholder handle_valid/2 with full entropy-overwrite-and-broadcast implementation | mix compile --warnings-as-errors | pending |
| 2.4.2.b | Test POST valid payload returns HTTP 202 with trace_id | mix test test/observatory_web/controllers/gateway_controller_test.exs --only success | pending |
| 2.4.2.c | Test POST valid payload broadcasts {:decision_log, log} on gateway:messages | mix test test/observatory_web/controllers/gateway_controller_test.exs --only success | pending |
| 2.4.2.d | Test schema-rejected payload never broadcasts on gateway:messages | mix test test/observatory_web/controllers/gateway_controller_test.exs --only success | pending |
| 2.4.2.e | Test broadcast failure on success path still returns HTTP 202 | mix test test/observatory_web/controllers/gateway_controller_test.exs --only success | pending |
| 2.4.2.f | Run full gateway test suite and compile with --warnings-as-errors | mix test test/observatory/gateway/ test/observatory_web/controllers/gateway_controller_test.exs && mix compile --warnings-as-errors | pending |
