---
type: task
id: "4.1.1"
section_id: "4.1"
title: "GenServer Module and State Map"
status: pending
governed_by: ["ADR-019"]
parent_uc: ["UC-0260", "UC-0261"]
---

# Task 4.1.1: GenServer Module and State Map

## Goal

Create `lib/observatory/gateway/heartbeat_manager.ex` under the module `Observatory.Gateway.HeartbeatManager`. Declare `@eviction_threshold_seconds 90` and `@check_interval_ms 30_000`. Expose `record_heartbeat(agent_id, cluster_id)` returning `:ok`. The GenServer state is a map of `%{agent_id => %{last_seen: DateTime.t(), cluster_id: String.t()}}`. Start the 30-second check timer in `init/1` using `:timer.send_interval`.

## Governing Decisions

- ADR-019

## Verification UCs

- UC-0260
- UC-0261

## Subtasks

| ID | Title | Done When | Status |
|----|-------|-----------|--------|
| 4.1.1.1 | Create heartbeat_manager.ex with GenServer, module attrs, start_link/1, and timer init | mix compile --warnings-as-errors | pending |
| 4.1.1.2 | Implement record_heartbeat/2 as GenServer.call inserting/replacing state map entry | mix compile --warnings-as-errors | pending |
| 4.1.1.3 | Implement handle_info(:check_heartbeats) evicting stale agents via CapabilityMap.remove_agent | mix compile --warnings-as-errors | pending |
| 4.1.1.4 | Add HeartbeatManager to application supervisor in lib/observatory/application.ex | mix compile --warnings-as-errors | pending |
