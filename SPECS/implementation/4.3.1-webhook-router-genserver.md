---
type: task
id: "4.3.1"
section_id: "4.3"
title: "WebhookRouter GenServer and Retry Schedule"
status: pending
governed_by: ["ADR-020"]
parent_uc: ["UC-0268", "UC-0270"]
---

# Task 4.3.1: WebhookRouter GenServer and Retry Schedule

## Goal

Create `lib/observatory/gateway/webhook_router.ex`. Declare `@retry_schedule_seconds [30, 120, 600, 3600, 21600]` and `@poll_interval_ms 5_000`. The periodic poll queries `webhook_deliveries` rows with pending/failed status, takes at most 5, attempts delivery, and updates row status. After five consecutive failures, the row is marked `status: "dead"` and a `WebhookDLQEvent` is broadcast.

## Governing Decisions

- ADR-020

## Verification UCs

- UC-0268
- UC-0270

## Subtasks

| ID | Title | Done When | Status |
|----|-------|-----------|--------|
| 4.3.1.1 | Create webhook_router.ex with GenServer, retry schedule attrs, and startup requeue | mix compile --warnings-as-errors | pending |
| 4.3.1.2 | Implement handle_info(:poll) querying pending/failed rows (limit 5) and calling attempt_delivery/1 | mix compile --warnings-as-errors | pending |
| 4.3.1.3 | Implement attempt_delivery/1 with HTTP POST, mark_delivered/1, and schedule_retry/1 with DLQ broadcast at attempt 5 | mix compile --warnings-as-errors | pending |
| 4.3.1.4 | Implement requeue_undelivered/0 resetting past-due next_retry_at to now on startup | mix compile --warnings-as-errors | pending |
| 4.3.1.5 | Add WebhookRouter to application supervisor | mix compile --warnings-as-errors | pending |
