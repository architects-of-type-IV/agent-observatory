---
id: ADR-010
title: Component File Split Pattern (embed_templates)
date: 2026-02-21
status: accepted
related_tasks: []
parent: null
superseded_by: null
---
# ADR-010 Component File Split Pattern (embed_templates)
[2026-02-21] accepted

## Related ADRs
- [ADR-011](ADR-011-handler-delegation.md) Handler Delegation Pattern (complementary decomposition strategy)

## References

| Reference | Location | Notes |
|-----------|----------|-------|
| Swarm Control Center Design | [CONV-001](../conversations/CONV-001-swarm-control-center.md) | File split emerged during component implementation |
| Session JSONL | `~/.claude/projects/-Users-xander-code-www-kardashev-observatory/1f469adb-7830-4fb9-ac26-af6d0b3fbc45.jsonl` | Raw session transcript |

### Key Moments

| Timestamp | What was discussed |
|-----------|-------------------|
| 2026-02-21T13:28:40Z | User: "split large files into .ex and .heex" |
| 2026-02-21T13:46:04Z | 4 large files split, embed_templates pattern established |
| 2026-02-21T14:12:05Z | Discovered `attr` + `embed_templates` incompatibility, established workaround |

## Context

Component modules were growing past the 200-300 line limit. A single `.ex` file containing both logic and large HEEx templates became hard to navigate. The 200-300 line module size limit (project convention) was being violated.

## Decision

Split large component modules into `.ex` (logic + helpers) + `.heex` (templates via `embed_templates`):

- **`.ex` file:** `use Phoenix.Component`, imports, helper functions, multi-head pattern-matched dispatch functions (e.g., `defp segment(%{segment: %{type: :parent}} = assigns), do: parent_segment(assigns)`)
- **`.heex` files:** Templates generated by `embed_templates`. Preprocessing in `<% %>` blocks at the top of each template.
- **Exception:** `attr` declarations are incompatible with `embed_templates` (Phoenix Component throws "could not define attributes" error). Use inline `~H` for small components under 30 lines.

## Rationale

Templates are the bulk of component size. Extracting them into separate `.heex` files keeps `.ex` files focused on logic and under the size limit. The `embed_templates` macro generates function heads automatically from filenames, reducing boilerplate.

Multi-head pattern-matched dispatch stays in `.ex` because template file naming can't express pattern matching. The dispatch function in `.ex` calls the generated template function: `defp segment(%{segment: %{type: :parent}} = assigns), do: parent_segment(assigns)`.

## Consequences

- Split 4 large component modules: ~1,471 lines reduced to ~313 lines in `.ex` files + 16 `.heex` templates
- `mix clean` required after converting `embed_templates` to inline templates (stale `.beam` files cause redefinition warnings)
- Format-on-save race condition: Edit tool fails when hooks modify file between Read and Edit. Use `sed -i ''` via Bash as workaround.
- `defdelegate` facade preserves backward compatibility when extracting components to sub-modules
