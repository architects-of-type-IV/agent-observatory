---
id: UC-0310
title: Activate God Mode Kill-Switch via Double Confirmation
status: draft
parent_fr: FR-12.11
adrs: [ADR-022]
---

# UC-0310: Activate God Mode Kill-Switch via Double Confirmation

## Intent
The God Mode kill-switch pauses all non-essential routing across the mesh. To prevent accidental activation, the operator must complete two separate, sequential confirmation steps before the pause command is dispatched. The LiveView tracks confirmation progress in the `kill_switch_confirm_step` socket assign, which cycles through `nil`, `:first`, and `:second`. Dismissing or cancelling either confirmation modal at any point resets the step to `nil` without any partial execution. The mesh state is only modified after the second confirmation is approved.

## Primary Actor
Operator

## Supporting Actors
- DashboardLive socket
- GodModeComponents module
- `kill_switch_confirm_step` socket assign (`nil | :first | :second`)
- First confirmation modal component
- Second confirmation modal or inline confirmation step component
- Mesh pause command backend

## Preconditions
- DashboardLive is mounted with `view_mode: :god_mode`.
- `kill_switch_confirm_step` is `nil` (no confirmation in progress).
- The mesh is currently in an active (non-paused) state.

## Trigger
The operator clicks the kill-switch button in the God Mode view.

## Main Success Flow
1. The operator clicks the kill-switch button.
2. `handle_event("kill_switch_click", %{}, socket)` sets `kill_switch_confirm_step: :first`.
3. The first confirmation modal renders, presenting the scope and consequences of pausing the mesh.
4. The operator clicks the `Confirm` button in the first modal.
5. `handle_event("kill_switch_first_confirm", %{}, socket)` sets `kill_switch_confirm_step: :second`.
6. The second confirmation modal or inline confirmation step renders.
7. The operator clicks the `Confirm` button in the second confirmation.
8. `handle_event("kill_switch_second_confirm", %{}, socket)` dispatches the pause command to the backend.
9. The mesh enters paused state.
10. `kill_switch_confirm_step` is reset to `nil`.
11. A success indicator renders in the God Mode view confirming the mesh is paused.

## Alternate Flows
### A1: Operator dismisses the first confirmation modal
Condition: The first modal is open (`kill_switch_confirm_step: :first`); the operator clicks `Cancel` or the modal dismiss control.
Steps:
1. `handle_event("kill_switch_cancel", %{}, socket)` sets `kill_switch_confirm_step: nil`.
2. The modal is dismissed.
3. No pause command is dispatched.
4. The mesh state is unchanged.

### A2: Operator dismisses the second confirmation step
Condition: The second confirmation is open (`kill_switch_confirm_step: :second`); the operator clicks `Cancel`.
Steps:
1. `handle_event("kill_switch_cancel", %{}, socket)` sets `kill_switch_confirm_step: nil`.
2. Both confirmation steps are closed.
3. No pause command is dispatched.
4. The mesh state is unchanged.

## Failure Flows
### F1: Single button press does not dispatch the pause command
Condition: A test or automated agent sends only the initial `kill_switch_click` event without completing both confirmation steps.
Steps:
1. `kill_switch_confirm_step` advances to `:first`.
2. No further confirmation events are received.
3. No pause command is dispatched.
Result: The mesh remains active; `kill_switch_confirm_step` stays at `:first` (awaiting the next user action); the kill-switch has not fired from a single event.

## Gherkin Scenarios

### S1: Full double-confirm flow dispatches the pause command
```gherkin
Scenario: Operator completes both confirmations and mesh is paused
  Given the socket assign "view_mode" equals ":god_mode"
  And the socket assign "kill_switch_confirm_step" equals nil
  When the operator clicks the kill-switch button triggering "kill_switch_click"
  Then the socket assign "kill_switch_confirm_step" equals ":first"
  When the operator confirms in the first modal triggering "kill_switch_first_confirm"
  Then the socket assign "kill_switch_confirm_step" equals ":second"
  When the operator confirms in the second step triggering "kill_switch_second_confirm"
  Then the mesh pause command is dispatched to the backend
  And the socket assign "kill_switch_confirm_step" equals nil
```

### S2: Dismissing the first modal resets state without dispatching pause
```gherkin
Scenario: Operator dismisses first confirmation modal and no pause is dispatched
  Given the socket assign "view_mode" equals ":god_mode"
  And the socket assign "kill_switch_confirm_step" equals ":first"
  When the operator clicks Cancel triggering "kill_switch_cancel"
  Then the socket assign "kill_switch_confirm_step" equals nil
  And the mesh pause command is not dispatched
```

### S3: Single kill_switch_click event alone does not dispatch pause
```gherkin
Scenario: Single button press advances confirm step but does not dispatch pause
  Given the socket assign "view_mode" equals ":god_mode"
  And the socket assign "kill_switch_confirm_step" equals nil
  When the "kill_switch_click" event is sent once with no subsequent confirmation events
  Then the socket assign "kill_switch_confirm_step" equals ":first"
  And the mesh pause command is not dispatched
```

## Acceptance Criteria
- [ ] `mix test test/observatory_web/live/god_mode_test.exs` passes a test that sends `kill_switch_click`, `kill_switch_first_confirm`, and `kill_switch_second_confirm` in sequence, asserting `kill_switch_confirm_step` transitions through `nil` -> `:first` -> `:second` -> `nil` and the pause command is dispatched.
- [ ] `mix test test/observatory_web/live/god_mode_test.exs` passes a test that sends `kill_switch_click` followed by `kill_switch_cancel` and asserts `kill_switch_confirm_step` resets to `nil` and no pause command is dispatched.
- [ ] `mix test test/observatory_web/live/god_mode_test.exs` passes a test that sends only `kill_switch_click` (no confirmation events) and asserts the pause command is not dispatched.
- [ ] `mix compile --warnings-as-errors` passes.

## Data
**Inputs:** `kill_switch_click`, `kill_switch_first_confirm`, `kill_switch_second_confirm`, `kill_switch_cancel` events
**Outputs:** `kill_switch_confirm_step` state transitions, mesh pause command dispatch (on full confirmation)
**State changes:** `kill_switch_confirm_step` cycles: `nil` -> `:first` -> `:second` -> `nil` (on success or cancellation at any step).

## Traceability
- Parent FR: FR-12.11
- ADR: [ADR-022](../../decisions/ADR-022-six-view-ui-architecture.md)
