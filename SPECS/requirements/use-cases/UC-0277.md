---
id: UC-0277
title: Operator Approves, Rewrites, or Rejects Buffered Agent Action
status: draft
parent_fr: FR-11.10
adrs: [ADR-021]
---

# UC-0277: Operator Approves, Rewrites, or Rejects Buffered Agent Action

## Intent
The Session Drill-down LiveView presents an approval gate when a `HITLGateOpenEvent` is received. The operator chooses one of three actions — Approve, Rewrite, or Reject — each of which resolves the pause via a specific sequence of HITL API calls. The Reject path injects a synthetic rejection prompt before unpausing so the agent receives clear feedback.

## Primary Actor
HITLRelay

## Supporting Actors
- Session Drill-down LiveView (approval gate UI)
- `POST /gateway/sessions/:session_id/unpause` endpoint
- `POST /gateway/sessions/:session_id/rewrite` endpoint
- `POST /gateway/sessions/:session_id/inject` endpoint
- PubSub topic `"session:hitl:#{session_id}"`

## Preconditions
- The Session Drill-down LiveView is mounted and subscribed to `"session:hitl:#{session_id}"`.
- The LiveView has received a `HITLGateOpenEvent` and is rendering the approval gate.
- The session is in `Paused` state with at least one buffered DecisionLog.

## Trigger
The operator clicks one of the three approval gate action buttons: Approve, Rewrite, or Reject.

## Main Success Flow (Approve Path)
1. The operator clicks Approve.
2. The LiveView sends `POST /gateway/sessions/:session_id/unpause` with the operator's ID.
3. HITLRelay flushes the ETS buffer in order on the standard DecisionLog topic.
4. HITLRelay transitions the session to `Normal` and broadcasts `HITLGateCloseEvent`.
5. The LiveView receives `HITLGateCloseEvent` and hides the approval gate.

## Alternate Flows
### A1: Rewrite Path
Condition: The operator edits the buffered message content in the approval gate UI and submits.
Steps:
1. The operator edits the content and clicks Rewrite.
2. The LiveView sends `POST /gateway/sessions/:session_id/rewrite` with the edited content as `new_content` and the buffered message's `meta.trace_id` as `original_trace_id`.
3. HITLRelay replaces the targeted ETS buffer entry with the rewritten content.
4. The LiveView immediately sends `POST /gateway/sessions/:session_id/unpause`.
5. HITLRelay flushes the buffer (with the rewrite applied) in order.
6. HITLRelay transitions to `Normal` and broadcasts `HITLGateCloseEvent`.
7. The LiveView hides the approval gate.

### A2: Reject Path
Condition: The operator clicks Reject.
Steps:
1. The LiveView sends `POST /gateway/sessions/:session_id/inject` with `prompt: "action rejected by operator, do not retry"`.
2. HITLRelay appends the synthetic rejection prompt to the ETS buffer (it becomes the first entry in the flush order because it is injected before unpause but after the existing buffered logs).
3. The LiveView immediately sends `POST /gateway/sessions/:session_id/unpause`.
4. HITLRelay flushes the buffer in order: existing logs first, then the injected rejection prompt.
5. HITLRelay transitions to `Normal` and broadcasts `HITLGateCloseEvent`.
6. The LiveView hides the approval gate.

## Failure Flows
### F1: Reject Without Inject (Operator Error)
Condition: The Reject path is misconfigured and only calls `/unpause` without calling `/inject` first.
Steps:
1. The buffer is flushed as-is without any rejection feedback.
2. The agent receives the buffered DecisionLogs without any indication the action was rejected.
3. The agent may retry the rejected action autonomously.
Result: Incorrect behavior. The Reject path MUST always call `/inject` before `/unpause`. This is enforced in the LiveView event handler, not in HITLRelay.

## Gherkin Scenarios

### S1: Approve path flushes buffer and closes gate
```gherkin
Scenario: Operator approval flushes buffer and closes approval gate
  Given session "sess-abc" is in Paused state with buffered DecisionLog T1
  And the Session Drill-down LiveView is rendering the approval gate
  When the operator clicks Approve
  Then the LiveView sends POST /gateway/sessions/sess-abc/unpause
  And T1 is broadcast on the standard DecisionLog topic for "sess-abc"
  And a HITLGateCloseEvent is broadcast on "session:hitl:sess-abc"
  And the approval gate is hidden in the LiveView
```

### S2: Reject path injects rejection prompt before unpause
```gherkin
Scenario: Operator rejection injects synthetic prompt then flushes buffer
  Given session "sess-abc" is in Paused state with buffered DecisionLog T1
  When the operator clicks Reject
  Then the LiveView sends POST /gateway/sessions/sess-abc/inject with prompt "action rejected by operator, do not retry"
  And then the LiveView sends POST /gateway/sessions/sess-abc/unpause
  And the flush order broadcasts T1 followed by the synthetic rejection prompt
  And the session transitions to Normal state
```

### S3: Rewrite path modifies content before flush
```gherkin
Scenario: Operator rewrites buffered message then unpauses
  Given session "sess-abc" is in Paused state with buffered DecisionLog T1 with trace_id "trace-T1"
  When the operator edits the content to "approved with edits" and clicks Rewrite
  Then the LiveView sends POST /gateway/sessions/sess-abc/rewrite with original_trace_id "trace-T1" and new_content "approved with edits"
  And the LiveView sends POST /gateway/sessions/sess-abc/unpause
  And the flush broadcasts T1_rewritten with content "approved with edits"
  And the session transitions to Normal state
```

## Acceptance Criteria
- [ ] `mix test test/observatory/gateway/hitl_relay_test.exs` passes a test that the Approve path flushes the buffer in order and broadcasts `HITLGateCloseEvent`.
- [ ] `mix test test/observatory/gateway/hitl_relay_test.exs` passes a test that the Reject path (inject then unpause) results in the rejection prompt being broadcast after the buffered DecisionLogs.
- [ ] `mix test test/observatory/gateway/hitl_relay_test.exs` passes a test that the Rewrite path modifies the targeted buffer entry and the modified content is broadcast during unpause.
- [ ] `mix compile --warnings-as-errors` passes.

## Data
**Inputs:** Operator action (Approve/Rewrite/Reject); `session_id`; operator-edited content and `original_trace_id` for Rewrite; rejection prompt string for Reject
**Outputs:** PubSub broadcasts of buffered (and optionally modified) DecisionLogs; `HITLGateCloseEvent`; HTTP 200 for each endpoint call
**State changes:** HITLRelay session: `Paused` -> `Normal`; ETS buffer cleared; `HITLInterventionEvent` rows created for rewrite and inject commands.

## Traceability
- Parent FR: FR-11.10
- ADR: [ADR-021](../../decisions/ADR-021-hitl-intervention-api.md)
