---
id: UC-0268
title: Retry Webhook Delivery with Exponential Backoff and Dead Letter
status: draft
parent_fr: FR-10.9
adrs: [ADR-020]
---

# UC-0268: Retry Webhook Delivery with Exponential Backoff and Dead Letter

## Intent
When a webhook delivery attempt fails, the WebhookRouter updates the `webhook_deliveries` row with incremented `attempt_count`, `status: "failed"`, and a `next_retry_at` derived from the exact exponential backoff schedule. After five consecutive failures, the row is marked `status: "dead"` and a `WebhookDLQEvent` is broadcast on `"gateway:webhooks"`. No further automatic retries occur for dead entries.

## Primary Actor
WebhookRouter

## Supporting Actors
- `webhook_deliveries` SQLite table
- PubSub topic `"gateway:webhooks"`
- `@retry_schedule_seconds` module attribute `[30, 120, 600, 3600, 21600]`

## Preconditions
- A `webhook_deliveries` row exists with `status: "pending"` or `status: "failed"` and `attempt_count` between 0 and 4.
- The WebhookRouter periodic poll has found this row as due (`next_retry_at <= DateTime.utc_now()`).
- The outbound HTTP request to `target_url` fails (non-2xx response or network error).

## Trigger
The WebhookRouter periodic poll selects a due `webhook_deliveries` row and the outbound HTTP delivery attempt returns a failure.

## Main Success Flow
1. The WebhookRouter poll queries `webhook_deliveries WHERE status IN ('pending','failed') AND next_retry_at <= now()`.
2. The router attempts an outbound HTTP POST to `target_url` with the HMAC-signed payload.
3. The delivery fails (network error or non-2xx HTTP status).
4. The router increments `attempt_count` by 1.
5. The router looks up the retry delay: `delay_seconds = Enum.at(@retry_schedule_seconds, attempt_count - 1)`.
6. `next_retry_at = DateTime.add(DateTime.utc_now(), delay_seconds, :second)`.
7. The router updates the row: `status: "failed"`, `attempt_count`, `last_attempted_at: DateTime.utc_now()`, `next_retry_at`, `error_detail` (response body or error reason).
8. The row update is persisted to the database before the router releases the row.
9. The router returns to its main loop.

## Alternate Flows
### A1: Delivery Succeeds
Condition: The outbound HTTP request returns a 2xx response.
Steps:
1. The router updates the row with `status: "delivered"`, `last_attempted_at: DateTime.utc_now()`, `next_retry_at: nil`.
2. A delivery success event is broadcast on `"gateway:webhooks"`.
3. No further retries are scheduled.

## Failure Flows
### F1: Fifth Consecutive Failure â€” Dead Letter
Condition: `attempt_count` reaches 5 after a failure (the row has now failed all five retry attempts).
Steps:
1. The router sets `status: "dead"` on the row.
2. `next_retry_at` is set to nil.
3. The router broadcasts `%WebhookDLQEvent{webhook_delivery_id: id, webhook_id: webhook_id, session_id: session_id}` on `Phoenix.PubSub.broadcast(Observatory.PubSub, "gateway:webhooks", event)`.
4. No further automatic retry is scheduled for this row.
Result: The row is marked dead; the operator must manually reset `attempt_count: 0` and `status: "pending"` to re-enable retries.

## Gherkin Scenarios

### S1: Failed attempt 1 sets 30-second next_retry_at
```gherkin
Scenario: First delivery failure schedules 30-second retry
  Given a webhook_deliveries row with status "pending" and attempt_count 0
  And the target_url returns a 500 response
  When the WebhookRouter processes this row
  Then the row is updated with status "failed", attempt_count 1
  And next_retry_at is approximately 30 seconds from now
  And error_detail contains the failure reason
```

### S2: Fifth failure transitions row to dead and broadcasts DLQ event
```gherkin
Scenario: Fifth consecutive delivery failure marks row dead and emits WebhookDLQEvent
  Given a webhook_deliveries row with status "failed" and attempt_count 4
  And the target_url returns a 500 response
  When the WebhookRouter processes this row
  Then the row is updated with status "dead" and attempt_count 5
  And a WebhookDLQEvent is broadcast on the "gateway:webhooks" PubSub topic
  And no next_retry_at is set
```

## Acceptance Criteria
- [ ] `mix test test/observatory/gateway/webhook_router_test.exs` passes a test that a failed delivery attempt with `attempt_count: 0` sets the row to `status: "failed"`, `attempt_count: 1`, and `next_retry_at` approximately 30 seconds in the future.
- [ ] `mix test test/observatory/gateway/webhook_router_test.exs` passes a test that a failed delivery with `attempt_count: 4` sets `status: "dead"` and broadcasts a `WebhookDLQEvent` on `"gateway:webhooks"`.
- [ ] `mix compile --warnings-as-errors` passes.

## Data
**Inputs:** Due `webhook_deliveries` row; HTTP response from `target_url`
**Outputs:** Updated `webhook_deliveries` row; `WebhookDLQEvent` on dead-letter
**State changes:** `attempt_count` incremented, `status` updated, `next_retry_at` computed from `@retry_schedule_seconds` and persisted.

## Traceability
- Parent FR: FR-10.9
- ADR: [ADR-020](../../decisions/ADR-020-webhook-retry-dlq.md)
