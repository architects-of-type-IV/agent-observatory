---
id: UC-0130
title: Enforce content rules for .heex template files
status: draft
parent_fr: FR-5.6
adrs: [ADR-010]
---

# UC-0130: Enforce Content Rules for .heex Template Files

## Intent
`.heex` template files generated via `embed_templates` may contain only HEEx markup and preprocessing `<% %>` blocks at the top of the file for computing local variables. Function definitions (`def`, `defp`) must not appear in `.heex` files. Violations cause compile-time errors that are caught by `mix compile --warnings-as-errors`.

## Primary Actor
Developer

## Supporting Actors
- Phoenix `embed_templates` macro (compiles `.heex` files)
- `mix compile --warnings-as-errors` (catches syntax and compile errors)

## Preconditions
- A component module uses `embed_templates` and has co-located `.heex` files.
- A developer is authoring or reviewing a `.heex` template file.

## Trigger
A developer writes or modifies a `.heex` file.

## Main Success Flow
1. The developer opens a `.heex` file to add or modify markup.
2. Preprocessing assigns are placed in `<% %>` blocks at the top: `<% color = segment_color(@segment) %>`.
3. The computed variable is used in the markup below: `<span class={color}>`.
4. No `def` or `defp` keyword appears anywhere in the file.
5. `mix compile --warnings-as-errors` passes with zero warnings.

## Alternate Flows

### A1: Complex computation needed in template
Condition: A template requires a non-trivial computation before rendering.
Steps:
1. The computation is implemented as a helper function in the `.ex` file.
2. The `.heex` file calls the helper via a `<% %>` block: `<% result = MyComponent.compute(@data) %>`.
3. No function definition appears in the `.heex` file.

## Failure Flows

### F1: Developer writes a defp inside a .heex file
Condition: `<% defp helper(x), do: x + 1 %>` is written in a `.heex` file.
Steps:
1. `embed_templates` attempts to compile the file as a function body.
2. `mix compile` produces a compile-time error: function definitions are not permitted in templates.
3. The developer moves the helper to the `.ex` file.
4. `mix compile --warnings-as-errors` passes after correction.
Result: Compile error acts as a hard guard against function definitions in templates.

## Gherkin Scenarios

### S1: Preprocessing block computes a variable for use in markup
```gherkin
Scenario: A .heex file uses a preprocessing block to compute a local variable
  Given parent_segment.heex contains <% color = segment_color(@segment) %>
  And the markup below uses <%= color %> in a class attribute
  When mix compile --warnings-as-errors runs
  Then compilation succeeds with zero warnings
  And the rendered output uses the computed color value
```

### S2: Function definition in .heex causes compile error
```gherkin
Scenario: A defp in a .heex file causes a compile-time error
  Given a .heex file contains <% defp helper(x), do: x + 1 %>
  When mix compile runs
  Then compilation fails with an error message
  And moving the helper to the .ex file resolves the error
```

### S3: .heex file with only markup and no preprocessing compiles cleanly
```gherkin
Scenario: A pure markup .heex file with no preprocessing blocks compiles
  Given tool_result.heex contains only HEEx markup with no <% %> blocks
  When mix compile --warnings-as-errors runs
  Then compilation succeeds with zero warnings
```

## Acceptance Criteria
- [ ] `grep -rn "defp\|def " lib/observatory_web/components/*.heex` returns no matches (S1, S2).
- [ ] All `.heex` files in `lib/observatory_web/components/` compile cleanly via `mix compile --warnings-as-errors` (S1, S3).
- [ ] A test `.heex` file containing a `defp` block causes `mix compile` to fail (used in development to validate the guard, not a runtime test) (S2).

## Data
**Inputs:** `.heex` file content: HEEx markup; optional `<% %>` preprocessing blocks
**Outputs:** Compiled template function generated by `embed_templates`
**State changes:** No persistent state changes; compile-time code generation only

## Traceability
- Parent FR: [FR-5.6](../frds/FRD-005-code-architecture-patterns.md)
- ADR: [ADR-010](../../decisions/ADR-010-component-file-split.md)
