---
id: UC-0272
title: Buffer Incoming DecisionLogs During Session Pause
status: draft
parent_fr: FR-11.2
adrs: [ADR-021]
---

# UC-0272: Buffer Incoming DecisionLogs During Session Pause

## Intent
While a session is in `Paused` state, every incoming DecisionLog for that session is appended to an ETS list keyed by `{session_id, agent_id}` in arrival order. None of these messages are forwarded on PubSub until the session is unpaused. An operator may rewrite a specific buffered entry by its `meta.trace_id` before the flush occurs.

## Primary Actor
HITLRelay

## Supporting Actors
- `:hitl_buffer` ETS table (`ordered_set`)
- `HITLInterventionEvent` Ash resource
- Phoenix.PubSub (withheld until unpause)

## Preconditions
- The HITLRelay GenServer is running.
- Session `session_id` is in `Paused` state.
- The `:hitl_buffer` ETS table exists with the `{session_id, agent_id}` key initialized.

## Trigger
HITLRelay receives an incoming DecisionLog addressed to a `Paused` session.

## Main Success Flow
1. HITLRelay receives a validated DecisionLog for `session_id`.
2. It looks up the session state and confirms it is `Paused`.
3. It fetches the current buffer list from ETS at key `{session_id, agent_id}`.
4. It appends the DecisionLog struct to the end of the list (preserving arrival order).
5. It writes the updated list back to ETS at `{session_id, agent_id}`.
6. It does not broadcast the DecisionLog on any PubSub topic.

## Alternate Flows
### A1: Rewrite Command Targets Buffered Entry
Condition: The operator issues `POST /gateway/sessions/:session_id/rewrite` with a valid `original_trace_id` matching a buffered entry.
Steps:
1. HITLRelay fetches the buffer list from ETS at `{session_id, agent_id}`.
2. It locates the entry whose `meta.trace_id == original_trace_id`.
3. It replaces that entry's content with `new_content` in place.
4. It writes the modified list back to ETS.
5. A `HITLInterventionEvent` is created with `command_type: :hitl_rewrite`, `before_state: sha256(original_entry)`, `after_state: sha256(rewritten_entry)`.
6. The controller returns HTTP 200 `{"status": "ok"}`.

## Failure Flows
### F1: trace_id Not Found in Buffer
Condition: `original_trace_id` in the rewrite command does not match any buffered entry for `{session_id, agent_id}`.
Steps:
1. HITLRelay cannot locate the trace_id in the ETS buffer list.
2. HITLRelay returns an error to the controller.
3. The controller returns HTTP 422 `{"status": "error", "reason": "trace_id_not_found_in_buffer"}`.
4. No ETS entries are modified.
Result: The buffer is unchanged. The operator must resubmit with a valid `original_trace_id`.

## Gherkin Scenarios

### S1: Three DecisionLogs buffered in arrival order
```gherkin
Scenario: Paused session buffers DecisionLogs in arrival order
  Given session "sess-abc" is in Paused state
  And the :hitl_buffer ETS table has key {"sess-abc","agent-1"} mapped to []
  When DecisionLog T1 arrives, then T2, then T3 for session "sess-abc" and agent "agent-1"
  Then the :hitl_buffer ETS entry for {"sess-abc","agent-1"} is [T1, T2, T3]
  And no PubSub broadcast occurs for T1, T2, or T3
```

### S2: Rewrite replaces buffered entry by trace_id
```gherkin
Scenario: Operator rewrites buffered entry T2 by trace_id before unpause
  Given the :hitl_buffer ETS entry for {"sess-abc","agent-1"} is [T1, T2, T3]
  And T2.meta.trace_id is "trace-T2"
  When a POST to /gateway/sessions/sess-abc/rewrite is made with original_trace_id "trace-T2" and new_content "revised reasoning"
  Then the response status is 200
  And the :hitl_buffer ETS entry for {"sess-abc","agent-1"} is [T1, T2_rewritten, T3]
  And a HITLInterventionEvent row is created with command_type :hitl_rewrite
```

### S3: Rewrite with non-existent trace_id returns 422
```gherkin
Scenario: Rewrite with unknown trace_id returns 422 and leaves buffer unchanged
  Given the :hitl_buffer ETS entry for {"sess-abc","agent-1"} is [T1, T2, T3]
  When a POST to /gateway/sessions/sess-abc/rewrite is made with original_trace_id "trace-UNKNOWN"
  Then the response status is 422
  And the response body is {"status":"error","reason":"trace_id_not_found_in_buffer"}
  And the :hitl_buffer ETS entry for {"sess-abc","agent-1"} remains [T1, T2, T3]
```

## Acceptance Criteria
- [ ] `mix test test/observatory/gateway/hitl_relay_test.exs` passes a test that three DecisionLogs arriving while a session is paused are stored in ETS in arrival order and not broadcast.
- [ ] `mix test test/observatory/gateway/hitl_relay_test.exs` passes a test that `hitl_rewrite` with a valid `original_trace_id` replaces the matching entry in the ETS buffer and creates a `HITLInterventionEvent` row with `command_type: :hitl_rewrite`.
- [ ] `mix test test/observatory_web/controllers/gateway_controller_test.exs` passes a test that a rewrite with an unknown `original_trace_id` returns HTTP 422 with reason `trace_id_not_found_in_buffer`.
- [ ] `mix compile --warnings-as-errors` passes.

## Data
**Inputs:** Incoming DecisionLog structs; `original_trace_id` and `new_content` for rewrite
**Outputs:** ETS buffer updated; HTTP 422 on unknown trace_id; `HITLInterventionEvent` on successful rewrite
**State changes:** `:hitl_buffer` ETS list appended or modified; no PubSub broadcast until unpause.

## Traceability
- Parent FR: FR-11.2
- ADR: [ADR-021](../../decisions/ADR-021-hitl-intervention-api.md)
