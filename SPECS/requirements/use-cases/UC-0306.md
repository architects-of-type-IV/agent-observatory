---
id: UC-0306
title: Open Session Drill-Down with Causal DAG and HITL Console
status: draft
parent_fr: FR-12.7
adrs: [ADR-022]
---

# UC-0306: Open Session Drill-Down with Causal DAG and HITL Console

## Intent
The Session Cluster view provides the operator with an active session list, optionally filtered by high-entropy sessions. Selecting a session opens a drill-down that streams the session's causal DAG, live scratchpad intent values, and a HITL console for intervention. When the entropy filter is activated and no sessions meet the threshold, the panel renders a clear empty state rather than crashing. The Feed, Messages, Tasks, and Protocols panels from the previous navigation are available as collapsible sub-panels within this view.

## Primary Actor
Operator

## Supporting Actors
- DashboardLive socket
- SessionClusterComponents module
- `selected_session_id` socket assign
- `entropy_filter_active` socket assign
- Causal DAG drill-down component (per FRD-008)
- Live Scratchpad component (`cognition.intent` stream from DecisionLog)
- HITL Console component (per FRD-011)
- Entropy score data (`cognition.entropy_score` from DecisionLog, per FRD-009)

## Preconditions
- DashboardLive is mounted with `view_mode: :session_cluster`.
- The Active Session List is populated with at least one session.
- `selected_session_id` is nil (no drill-down open).

## Trigger
The operator clicks a session row in the Active Session List, triggering a `phx-click` event.

## Main Success Flow
1. The operator clicks a session row with session ID `"sess-xyz-789"`.
2. The `phx-click` event fires `handle_event("select_session", %{"session_id" => "sess-xyz-789"}, socket)`.
3. The handler sets `selected_session_id: "sess-xyz-789"` in socket assigns.
4. `SessionClusterComponents` renders with the drill-down panel open.
5. The Causal DAG panel renders the directed acyclic graph of DecisionLog steps for `"sess-xyz-789"`.
6. The Live Scratchpad panel begins streaming `cognition.intent` values from `"sess-xyz-789"`'s DecisionLog events in real time.
7. The HITL Console panel renders, ready for the operator to inject messages or signals.
8. The agent detail panel for agents within `"sess-xyz-789"` is available in the sidebar.

## Alternate Flows
### A1: Entropy Alert filter activated â€” sessions filtered to high-entropy only
Condition: The operator toggles the Entropy Alert filter (`entropy_filter_active: true`).
Steps:
1. A `phx-click` or `phx-change` event sets `entropy_filter_active: true`.
2. The session list re-renders showing only sessions whose `cognition.entropy_score` exceeds the configured threshold.
3. Sessions below the threshold are hidden from the list.

### A2: Entropy filter active but no high-entropy sessions exist
Condition: `entropy_filter_active: true`; all sessions have `cognition.entropy_score` below threshold.
Steps:
1. The session list filters to zero items.
2. The panel renders an empty state message: `"No high-entropy sessions."`.
3. No JavaScript error occurs; the HITL Console and other panels continue to render independently.

### A3: Operator opens a collapsible sub-panel (e.g., Feed)
Condition: The operator clicks the expand control for the Feed sub-panel.
Steps:
1. A `phx-click` event toggles `feed_panel_open: true`.
2. The Feed sub-panel renders the raw event stream for the selected session.

## Failure Flows
### F1: Selected session has no DecisionLog events
Condition: `"sess-xyz-789"` exists but no DecisionLog events have been received for it yet.
Steps:
1. The Causal DAG panel checks for nil or empty step data.
2. The DAG panel renders an empty state: `"No steps recorded."`.
3. The Live Scratchpad renders with no intent values streaming.
Result: No nil dereference error; drill-down opens successfully in an empty state.

## Gherkin Scenarios

### S1: Selecting a session opens the Causal DAG drill-down
```gherkin
Scenario: Operator selects a session and the drill-down panels open
  Given the socket assign "view_mode" equals ":session_cluster"
  And the socket assign "selected_session_id" equals nil
  And the active session list contains session "sess-xyz-789"
  When the operator clicks the session row for "sess-xyz-789"
  Then the socket assign "selected_session_id" equals "sess-xyz-789"
  And the rendered HTML contains the causal-dag-panel element
  And the rendered HTML contains the live-scratchpad-panel element
  And the rendered HTML contains the hitl-console-panel element
```

### S2: Entropy filter with no qualifying sessions shows empty state
```gherkin
Scenario: Entropy Alert filter active but no sessions exceed threshold
  Given the socket assign "view_mode" equals ":session_cluster"
  And the socket assign "entropy_filter_active" equals true
  And all sessions have entropy_score below the alert threshold
  When SessionClusterComponents renders the session list
  Then the rendered session list contains zero session rows
  And the rendered HTML contains the text "No high-entropy sessions"
  And no JavaScript error or server exception is raised
```

## Acceptance Criteria
- [ ] `mix test test/observatory_web/live/session_cluster_test.exs` passes a test that sends a `select_session` event and asserts `selected_session_id` is set and the rendered HTML contains the causal-dag-panel, live-scratchpad-panel, and hitl-console-panel elements.
- [ ] `mix test test/observatory_web/live/session_cluster_test.exs` passes a test that activates the entropy filter with no qualifying sessions and asserts the rendered HTML contains an empty-state message and no exception is raised.
- [ ] `mix compile --warnings-as-errors` passes.

## Data
**Inputs:** `phx-click` session selection event, `cognition.entropy_score` values, `cognition.intent` DecisionLog stream
**Outputs:** Rendered drill-down panel with DAG, scratchpad, HITL console; or entropy-filtered session list with empty state
**State changes:** `selected_session_id` set to the chosen session ID; `entropy_filter_active` toggled on/off.

## Traceability
- Parent FR: FR-12.7
- ADR: [ADR-022](../../decisions/ADR-022-six-view-ui-architecture.md)
