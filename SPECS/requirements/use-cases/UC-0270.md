---
id: UC-0270
title: Enforce Per-Poll Webhook Dispatch Cap to Prevent Thundering Herd
status: draft
parent_fr: FR-10.12
adrs: [ADR-020]
---

# UC-0270: Enforce Per-Poll Webhook Dispatch Cap to Prevent Thundering Herd

## Intent
The WebhookRouter periodic poll processes at most 5 due `webhook_deliveries` rows per cycle, regardless of how many rows are due. This cap prevents a burst of concurrent outbound HTTP requests from saturating the connection pool after an outage or restart. Remaining due rows are left for the next poll cycle.

## Primary Actor
WebhookRouter

## Supporting Actors
- `webhook_deliveries` SQLite table (compound index on `status, next_retry_at`)
- PubSub topic `"gateway:webhooks"`
- `@poll_interval_ms` module attribute (default 5000)

## Preconditions
- The WebhookRouter GenServer is running.
- The `webhook_deliveries` table contains more than 5 rows with `status IN ("pending","failed")` and `next_retry_at <= now()`.

## Trigger
The WebhookRouter receives its periodic `{:poll}` self-message every `@poll_interval_ms` milliseconds.

## Main Success Flow
1. The WebhookRouter receives the `:poll` message.
2. It queries the database: `Repo.all(from d in WebhookDelivery, where: d.status in ["pending","failed"] and d.next_retry_at <= ^DateTime.utc_now(), limit: 5)`.
3. It receives at most 5 rows from the query.
4. For each of the 5 rows: attempts outbound HTTP delivery, updates row status.
5. The remaining due rows (beyond the first 5) are not touched in this cycle.
6. The WebhookRouter schedules the next poll via `Process.send_after(self(), :poll, @poll_interval_ms)`.
7. On the subsequent poll cycle, up to 5 more due rows are processed.

## Alternate Flows
### A1: Fewer Than 5 Due Rows
Condition: The query returns fewer than 5 rows.
Steps:
1. All returned rows are processed.
2. No cap is enforced (fewer than max).
3. Next poll cycle runs normally.

### A2: Operator Resets Dead Entry to Pending
Condition: An operator sets a `status: "dead"` row's `status` to `"pending"` and `attempt_count` to `0` via the "Retry now" UI action.
Steps:
1. The row becomes eligible for the next poll query.
2. The full 6-attempt retry envelope is available from `attempt_count: 0`.
3. The row is processed in a subsequent poll cycle alongside other due rows.

## Failure Flows
### F1: Delivery Attempt Raises Exception
Condition: An outbound HTTP call raises an exception (e.g., connection refused) rather than returning an error response.
Steps:
1. The exception is caught within the per-row dispatch handler.
2. The row is updated to `status: "failed"` with `error_detail` set to the exception message.
3. `next_retry_at` is computed using `@retry_schedule_seconds` and the current `attempt_count`.
4. Processing continues for the remaining rows in the current batch.
Result: One failure does not abort the entire poll cycle batch.

## Gherkin Scenarios

### S1: Poll with 12 due rows dispatches exactly 5
```gherkin
Scenario: WebhookRouter poll caps outbound dispatch at 5 per cycle
  Given the webhook_deliveries table contains 12 rows with status "pending" and next_retry_at in the past
  When the WebhookRouter processes one :poll cycle
  Then exactly 5 outbound HTTP requests are made
  And 7 rows remain with status "pending" and are not modified in this cycle
  And the next poll cycle will process up to 5 more rows
```

### S2: Operator retry resets dead entry for full retry envelope
```gherkin
Scenario: Operator resets dead webhook delivery for retry
  Given a webhook_deliveries row with status "dead" and attempt_count 5
  When the operator sets status to "pending" and attempt_count to 0
  Then in the next poll cycle the row is eligible for dispatch
  And on failure the row is retried with the full @retry_schedule_seconds schedule starting from attempt 1
```

## Acceptance Criteria
- [ ] `mix test test/observatory/gateway/webhook_router_test.exs` passes a test that a poll cycle with 12 due rows results in exactly 5 outbound HTTP calls and 7 rows untouched.
- [ ] `mix test test/observatory/gateway/webhook_router_test.exs` passes a test that a `status: "dead"` row reset to `status: "pending"` and `attempt_count: 0` is picked up in the next poll and retried with the first slot of `@retry_schedule_seconds` on failure.
- [ ] `mix compile --warnings-as-errors` passes.

## Data
**Inputs:** `webhook_deliveries` rows due for retry; `@poll_interval_ms`; operator reset action
**Outputs:** At most 5 outbound HTTP delivery attempts per poll cycle; row status updates
**State changes:** Up to 5 `webhook_deliveries` rows updated per cycle; all others deferred.

## Traceability
- Parent FR: FR-10.12
- ADR: [ADR-020](../../decisions/ADR-020-webhook-retry-dlq.md)
