---
id: UC-0305
title: Render Fleet Command View with Live Mesh Panels
status: draft
parent_fr: FR-12.6
adrs: [ADR-022]
---

# UC-0305: Render Fleet Command View with Live Mesh Panels

## Intent
When the operator navigates to `:fleet_command`, the FleetCommandComponents module renders a primary layout containing the Mesh Topology Map canvas as the dominant element, surrounded by five secondary panels: throughput, cost heatmap, infrastructure health, latency, and mTLS status. All six elements populate from the `swarm:update` PubSub topic. If no PubSub data arrives during the mount cycle, every panel renders in a graceful loading or empty state rather than raising a nil dereference. The former agent grid from the `:command` view must be accessible as a collapsible sub-panel within this view.

## Primary Actor
Operator

## Supporting Actors
- DashboardLive socket
- FleetCommandComponents module
- `swarm:update` PubSub topic
- Mesh Topology Map canvas component (per FRD-008)
- DecisionLog stream (`state_delta.cumulative_session_cost` field)

## Preconditions
- DashboardLive is mounted with `view_mode: :fleet_command`.
- The Phoenix PubSub process is running and the LiveView is subscribed to `"swarm:update"`.
- DecisionLog events may or may not have arrived yet.

## Trigger
The operator navigates to `:fleet_command` (by pressing `"1"`, via localStorage restore, or on first mount).

## Main Success Flow
1. `DashboardLive.render/1` dispatches to `FleetCommandComponents.fleet_command_view(assigns)`.
2. The Mesh Topology Map canvas component renders in the dominant area of the viewport.
3. The throughput panel renders the aggregate message volume per second from `swarm:update` data in socket assigns.
4. The cost heatmap panel renders per-agent cumulative session costs from `state_delta.cumulative_session_cost` values.
5. The infrastructure health panel renders node status summaries.
6. The latency panel renders p50, p95, and p99 latency metrics.
7. The mTLS status panel renders certificate validity and mutual-auth posture indicators.
8. A collapsible section or sub-panel contains the agent grid (formerly the `:command` view's primary content).
9. All panels are populated with live data; no nil dereference error occurs.

## Alternate Flows
### A1: PubSub delivers updated swarm data after mount
Condition: A `swarm:update` message arrives after mount via `handle_info`.
Steps:
1. `handle_info({:swarm_update, payload}, socket)` updates the relevant socket assigns.
2. The LiveView re-renders the affected panels with new data.
3. The canvas component reflects updated topology.

### A2: Agent grid sub-panel is expanded by the operator
Condition: The operator clicks the expand control on the agent grid collapsible section.
Steps:
1. A `phx-click` event sets `agent_grid_open: true` in socket assigns.
2. The agent grid renders in its expanded state within the Fleet Command layout.

## Failure Flows
### F1: PubSub delivers no data within the mount cycle
Condition: No `swarm:update` message has arrived; socket assigns for mesh data are nil or empty maps.
Steps:
1. Each secondary panel checks for nil assigns using a guard or default value.
2. Each panel renders a placeholder â€” e.g., `"Loading..."` or `"No data"` text inside the panel container.
Result: No `ArgumentError` or nil dereference crash occurs; the operator sees a loading state rather than an error page.

## Gherkin Scenarios

### S1: Fleet Command renders all six layout elements with live data
```gherkin
Scenario: Fleet Command view renders mesh topology and all secondary panels
  Given the DashboardLive socket has view_mode assigned as :fleet_command
  And the socket assigns contain swarm mesh data from a prior swarm:update message
  When DashboardLive render/1 is invoked
  Then the rendered HTML contains the mesh-topology-canvas element
  And the rendered HTML contains the throughput-panel element
  And the rendered HTML contains the cost-heatmap-panel element
  And the rendered HTML contains the infrastructure-health-panel element
  And the rendered HTML contains the latency-panel element
  And the rendered HTML contains the mtls-status-panel element
```

### S2: Fleet Command renders graceful empty state when no PubSub data present
```gherkin
Scenario: Fleet Command panels render loading state when no swarm data is available
  Given the DashboardLive socket has view_mode assigned as :fleet_command
  And the socket assigns contain no swarm mesh data (all nil or empty)
  When DashboardLive render/1 is invoked
  Then the rendered HTML contains the fleet-command view container
  And no ArgumentError or nil dereference exception is raised
  And each panel container is present in the HTML with a placeholder or empty state
```

## Acceptance Criteria
- [ ] `mix test test/observatory_web/live/fleet_command_test.exs` passes a test that mounts with `view_mode: :fleet_command` and asserts the rendered HTML contains the topology canvas, all five secondary panel containers, and the agent grid collapsible section.
- [ ] `mix test test/observatory_web/live/fleet_command_test.exs` passes a test that mounts with nil mesh assigns and asserts no exception is raised and all panel containers are present with placeholder content.
- [ ] `mix compile --warnings-as-errors` passes.

## Data
**Inputs:** `swarm:update` PubSub messages, `state_delta.cumulative_session_cost` values from DecisionLog stream
**Outputs:** Rendered Fleet Command layout HTML with six populated panel elements
**State changes:** Read-only at render time; assigns updated by `handle_info` on PubSub receipt.

## Traceability
- Parent FR: FR-12.6
- ADR: [ADR-022](../../decisions/ADR-022-six-view-ui-architecture.md)
