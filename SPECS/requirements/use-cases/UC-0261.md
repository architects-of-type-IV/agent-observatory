---
id: UC-0261
title: Evict Stale Agent from HeartbeatManager and CapabilityMap
status: draft
parent_fr: FR-10.2
adrs: [ADR-019]
---

# UC-0261: Evict Stale Agent from HeartbeatManager and CapabilityMap

## Intent
The HeartbeatManager periodically checks all tracked agents for liveness. Any agent whose last heartbeat is older than the 90-second eviction threshold is removed from the in-memory state map and its capabilities are removed from the live CapabilityMap, ensuring stale entries do not accumulate without operator intervention.

## Primary Actor
HeartbeatManager

## Supporting Actors
- `Observatory.Gateway.CapabilityMap` (called via `remove_agent/1`)
- Logger (`:info` level eviction records)

## Preconditions
- The HeartbeatManager GenServer is running.
- At least one agent entry exists in the state map with `last_seen` more than 90 seconds ago.
- `@eviction_threshold_seconds` is defined as `90` and `@check_interval_ms` is defined as `30_000` in the module attributes.

## Trigger
The HeartbeatManager receives a self-sent `:check_heartbeats` message, fired by `:timer.send_interval/2` every 30 seconds.

## Main Success Flow
1. The HeartbeatManager receives the `:check_heartbeats` message in `handle_info/2`.
2. The manager iterates every `{agent_id, %{last_seen: dt, cluster_id: _}}` entry in the state map.
3. For each entry, it computes the elapsed seconds: `DateTime.diff(DateTime.utc_now(), dt, :second)`.
4. If elapsed seconds exceed `@eviction_threshold_seconds` (90), the manager evicts the entry:
   a. Removes `agent_id` from the state map.
   b. Calls `CapabilityMap.remove_agent(agent_id)`.
   c. Logs at `:info` with fields `agent_id` and `last_seen`.
5. Agents with `last_seen` within the threshold are left in the state map untouched.
6. The updated state map is returned from `handle_info/2`.

## Alternate Flows
### A1: No Agents Exceed Threshold
Condition: All entries in the state map have `last_seen` within 90 seconds.
Steps:
1. The iteration completes with no evictions.
2. The state map is returned unchanged.
3. No CapabilityMap calls are made.

## Failure Flows
### F1: CapabilityMap.remove_agent Raises
Condition: `CapabilityMap.remove_agent/1` raises an exception for the evicted agent.
Steps:
1. The exception propagates out of the `handle_info/2` callback.
2. The OTP supervisor restarts the HeartbeatManager.
3. In-memory state for remaining (non-evicted) agents is lost; they must re-register via heartbeat.
Result: A supervisor restart occurs. The `:info` log for the eviction may not be written if the crash precedes it.

## Gherkin Scenarios

### S1: Stale agent evicted at threshold
```gherkin
Scenario: Agent with last_seen 91 seconds ago is evicted
  Given the HeartbeatManager state contains "agent-99" with last_seen 91 seconds ago
  And "agent-99" capabilities exist in the CapabilityMap
  When the HeartbeatManager receives a :check_heartbeats message
  Then "agent-99" is removed from the HeartbeatManager state map
  And CapabilityMap.remove_agent("agent-99") is called exactly once
  And an :info log is emitted with agent_id "agent-99"
```

### S2: Agent within threshold is not evicted
```gherkin
Scenario: Agent with last_seen 89 seconds ago is retained
  Given the HeartbeatManager state contains "agent-10" with last_seen 89 seconds ago
  When the HeartbeatManager receives a :check_heartbeats message
  Then "agent-10" remains in the HeartbeatManager state map
  And CapabilityMap.remove_agent is not called for "agent-10"
```

## Acceptance Criteria
- [ ] `mix test test/observatory/gateway/heartbeat_manager_test.exs` passes a test that an agent with `last_seen` 91 seconds in the past is removed from state and `CapabilityMap.remove_agent/1` is called after a `:check_heartbeats` message.
- [ ] `mix test test/observatory/gateway/heartbeat_manager_test.exs` passes a test that an agent with `last_seen` 89 seconds in the past remains in state after a `:check_heartbeats` message.
- [ ] `mix compile --warnings-as-errors` passes.

## Data
**Inputs:** HeartbeatManager internal state map (agent_id => %{last_seen, cluster_id}); current `DateTime.utc_now()`
**Outputs:** Eviction side effects: state map mutation, `CapabilityMap.remove_agent/1` call, `:info` log
**State changes:** Stale entries removed from HeartbeatManager state map; stale agent removed from CapabilityMap.

## Traceability
- Parent FR: FR-10.2
- ADR: [ADR-019](../../decisions/ADR-019-heartbeat-leader-election.md)
