---
id: UC-0308
title: Retry Failed Webhook Delivery from Scheduler DLQ Panel
status: draft
parent_fr: FR-12.9
adrs: [ADR-022]
---

# UC-0308: Retry Failed Webhook Delivery from Scheduler DLQ Panel

## Intent
The Scheduler view gives the operator visibility into upcoming cron jobs, failed webhook deliveries in the Dead Letter Queue, and zombie agents in the Heartbeat Monitor. The DLQ retry action re-enqueues a failed delivery via a `phx-click` event without requiring a page reload. The Cron Job Dashboard uses distinct visual indicators for pending, running, and failed job states. When the DLQ is empty, the panel renders an empty state message without affecting the Heartbeat Monitor panel.

## Primary Actor
Operator

## Supporting Actors
- DashboardLive socket
- SchedulerComponents module
- Cron Job Dashboard component
- Dead Letter Queue panel component (per FRD-010)
- Heartbeat Monitor panel component (zombie agent list, per FRD-010)

## Preconditions
- DashboardLive is mounted with `view_mode: :scheduler`.
- The DLQ panel contains at least one failed webhook delivery entry.
- The Cron Job Dashboard contains at least one upcoming scheduled task.

## Trigger
The operator clicks the `Retry` button on a DLQ entry, triggering a `phx-click` event.

## Main Success Flow
1. The Scheduler view renders with the Cron Job Dashboard showing upcoming tasks with distinct visual indicators for pending, running, and failed states.
2. The DLQ panel shows two failed webhook deliveries, each with a payload preview, failure reason, and a `Retry` button.
3. The operator clicks the `Retry` button on DLQ entry with ID `"dlq-entry-001"`.
4. `handle_event("retry_dlq_entry", %{"entry_id" => "dlq-entry-001"}, socket)` is invoked.
5. The backend re-enqueues the delivery for `"dlq-entry-001"`.
6. The DLQ entry's state transitions from failed to pending in the socket assigns.
7. The DLQ panel re-renders: `"dlq-entry-001"` moves to a pending visual state (e.g., a spinner or `"Queued"` badge).
8. No page reload occurs.

## Alternate Flows
### A1: DLQ is empty
Condition: No failed webhook deliveries exist.
Steps:
1. The DLQ panel checks for an empty list in socket assigns.
2. The panel renders: `"No failed deliveries."` or equivalent empty state text.
3. No `Retry` buttons are rendered.
4. The Heartbeat Monitor panel continues to render independently with its zombie agent list.

### A2: Cron job state indicators render for each state
Condition: The Cron Job Dashboard contains a pending job, a running job, and a failed job.
Steps:
1. The pending job row renders with the `cron-status-pending` CSS class or indicator element.
2. The running job row renders with the `cron-status-running` CSS class or indicator element.
3. The failed job row renders with the `cron-status-failed` CSS class or indicator element.
4. The three states are visually distinct.

### A3: Heartbeat Monitor shows zombie agents
Condition: One or more agents have missed their heartbeat window.
Steps:
1. The Heartbeat Monitor panel renders a zombie agent list with the agent ID and last-seen timestamp for each.
2. Auto-scaling trigger events are listed in the panel.

## Failure Flows
### F1: Backend fails to re-enqueue the DLQ entry
Condition: The retry backend call returns an error.
Steps:
1. `handle_event("retry_dlq_entry", ...)` receives an error response from the backend.
2. The DLQ entry state remains failed.
3. A flash error message is set: `"Retry failed. Please try again."`.
4. The panel re-renders with the entry still in failed state and the flash message visible.
Result: No page reload; the operator can attempt retry again.

## Gherkin Scenarios

### S1: Clicking retry re-enqueues DLQ entry without page reload
```gherkin
Scenario: Operator retries a failed DLQ entry and it transitions to pending state
  Given the socket assign "view_mode" equals ":scheduler"
  And the DLQ panel contains entry "dlq-entry-001" in failed state
  When the operator clicks the Retry button for "dlq-entry-001"
  Then handle_event "retry_dlq_entry" is invoked with entry_id "dlq-entry-001"
  And the socket assign for "dlq-entry-001" state transitions to pending
  And the rendered DLQ entry for "dlq-entry-001" shows a pending visual indicator
  And no page reload occurs
```

### S2: Empty DLQ renders empty state and does not affect Heartbeat Monitor
```gherkin
Scenario: Empty DLQ panel renders empty state while Heartbeat Monitor renders independently
  Given the socket assign "view_mode" equals ":scheduler"
  And the DLQ entries list in socket assigns is empty
  When SchedulerComponents renders the Scheduler view
  Then the rendered DLQ panel contains the text "No failed deliveries"
  And the rendered HTML contains the heartbeat-monitor-panel element
  And no exception is raised
```

### S3: Cron Job Dashboard shows distinct visual states for pending, running, and failed jobs
```gherkin
Scenario: Cron Job Dashboard renders visually distinct job state indicators
  Given the socket assign "view_mode" equals ":scheduler"
  And the cron job list contains one pending job, one running job, and one failed job
  When SchedulerComponents renders the Scheduler view
  Then the pending job row contains the CSS class "cron-status-pending"
  And the running job row contains the CSS class "cron-status-running"
  And the failed job row contains the CSS class "cron-status-failed"
```

## Acceptance Criteria
- [ ] `mix test test/observatory_web/live/dashboard_live_test.exs` passes a test that sends a `retry_dlq_entry` event and asserts the DLQ entry state transitions to pending and a pending indicator is rendered.
- [ ] `mix test test/observatory_web/live/dashboard_live_test.exs` passes a test that mounts with an empty DLQ list and asserts the DLQ panel renders an empty state message without raising an exception.
- [ ] `mix test test/observatory_web/live/dashboard_live_test.exs` passes a test that mounts with a cron job list containing one pending, one running, and one failed job and asserts the rendered HTML contains the CSS classes `cron-status-pending`, `cron-status-running`, and `cron-status-failed` in distinct row elements.
- [ ] `mix compile --warnings-as-errors` passes.

## Data
**Inputs:** `phx-click` retry event with `entry_id`, DLQ entries list from socket assigns, cron job list from socket assigns
**Outputs:** Updated DLQ entry state (pending), re-rendered DLQ panel; or empty-state message; or cron job rows with distinct CSS state classes
**State changes:** DLQ entry state updated from `failed` to `pending` in socket assigns on successful retry; flash error set on retry failure.

## Traceability
- Parent FR: FR-12.9
- ADR: [ADR-022](../../decisions/ADR-022-six-view-ui-architecture.md)
