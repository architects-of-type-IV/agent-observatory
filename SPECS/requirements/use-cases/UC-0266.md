---
id: UC-0266
title: Schedule Reminder from Agent DecisionLog Tool Call
status: draft
parent_fr: FR-10.7
adrs: [ADR-019]
---

# UC-0266: Schedule Reminder from Agent DecisionLog Tool Call

## Intent
When an agent submits a DecisionLog with `action.tool_call == "schedule_reminder"`, the SchemaInterceptor extracts the delay and payload from `action.tool_input` and calls `CronScheduler.schedule_once/3` before forwarding the DecisionLog on its normal PubSub path. If the `tool_input` contains an invalid `delay_ms`, the SchemaInterceptor logs a warning and skips scheduling but still forwards the DecisionLog.

## Primary Actor
SchemaInterceptor

## Supporting Actors
- `Observatory.Gateway.CronScheduler` (called via `schedule_once/3`)
- Phoenix.PubSub (DecisionLog broadcast topic)
- Logger (`:warning` level for invalid inputs)

## Preconditions
- The SchemaInterceptor is active and processing incoming DecisionLog messages.
- The CronScheduler GenServer is running.
- The incoming DecisionLog has passed schema validation.

## Trigger
The SchemaInterceptor receives a validated DecisionLog struct where `action.tool_call == "schedule_reminder"`.

## Main Success Flow
1. The SchemaInterceptor inspects the validated DecisionLog and detects `action.tool_call == "schedule_reminder"`.
2. It reads `delay_ms = decision_log.action.tool_input["delay_ms"]` (integer) and `payload = decision_log.action.tool_input["payload"]` (map).
3. It validates that `delay_ms` is a positive integer.
4. It calls `CronScheduler.schedule_once(decision_log.identity.agent_id, delay_ms, payload)`.
5. It broadcasts the DecisionLog on its standard PubSub topic regardless of the `schedule_once` result.

## Alternate Flows
### A1: schedule_once Returns Error
Condition: `CronScheduler.schedule_once/3` returns `{:error, :invalid_delay}` (should not occur if guard in step 3 passes, but treated defensively).
Steps:
1. The SchemaInterceptor logs a warning including the returned error.
2. The DecisionLog is still forwarded on PubSub normally.

## Failure Flows
### F1: Invalid or Missing delay_ms in tool_input
Condition: `action.tool_input["delay_ms"]` is absent, not an integer, or is a non-positive integer.
Steps:
1. The SchemaInterceptor detects the invalid value.
2. It logs at `:warning`: `"invalid delay_ms for schedule_reminder: #{inspect(delay_ms)}"`.
3. It skips calling `CronScheduler.schedule_once/3`.
4. It broadcasts the DecisionLog on the standard PubSub topic as normal.
Result: No timer is registered; no `cron_jobs` row is written; the DecisionLog is still forwarded.

## Gherkin Scenarios

### S1: Valid schedule_reminder tool call triggers CronScheduler
```gherkin
Scenario: DecisionLog with schedule_reminder tool call schedules a reminder
  Given the SchemaInterceptor is processing DecisionLogs
  And the CronScheduler GenServer is running
  When a validated DecisionLog arrives with action.tool_call "schedule_reminder" and tool_input {"delay_ms": 60000, "payload": {"task": "check_quota"}}
  Then CronScheduler.schedule_once is called with agent_id from the DecisionLog, delay_ms 60000, and payload {"task": "check_quota"}
  And the DecisionLog is broadcast on its standard PubSub topic
```

### S2: Negative delay_ms in tool_input causes warning and skip
```gherkin
Scenario: schedule_reminder with negative delay_ms is skipped with a warning log
  Given the SchemaInterceptor is processing DecisionLogs
  When a validated DecisionLog arrives with action.tool_call "schedule_reminder" and tool_input {"delay_ms": -500}
  Then a :warning log is emitted containing "invalid delay_ms for schedule_reminder: -500"
  And CronScheduler.schedule_once is not called
  And the DecisionLog is still broadcast on its standard PubSub topic
```

## Acceptance Criteria
- [ ] `mix test test/observatory/gateway/cron_scheduler_test.exs` passes a test that a DecisionLog with `tool_call: "schedule_reminder"` and valid `delay_ms` causes the SchemaInterceptor to call `CronScheduler.schedule_once/3` and still broadcast the DecisionLog.
- [ ] `mix test test/observatory/gateway/cron_scheduler_test.exs` passes a test that a DecisionLog with `tool_call: "schedule_reminder"` and `delay_ms: -500` emits a `:warning` log, does not call `schedule_once/3`, and still broadcasts the DecisionLog.
- [ ] `mix compile --warnings-as-errors` passes.

## Data
**Inputs:** Validated DecisionLog with `action.tool_call == "schedule_reminder"` and `action.tool_input` map
**Outputs:** `CronScheduler.schedule_once/3` call (or warning log); DecisionLog broadcast on standard PubSub topic
**State changes:** `cron_jobs` row created if scheduling succeeds; DecisionLog forwarded regardless.

## Traceability
- Parent FR: FR-10.7
- ADR: [ADR-019](../../decisions/ADR-019-heartbeat-leader-election.md)
