---
id: UC-0309
title: Search Message Archive in Forensic Inspector
status: draft
parent_fr: FR-12.10
adrs: [ADR-022]
---

# UC-0309: Search Message Archive in Forensic Inspector

## Intent
The Forensic Inspector view provides the operator with a full-text queryable Message Archive over all DecisionLog events, a Cost Attribution panel grouped by Agent ID or Session ID, a Security panel with webhook signature validation status, and a Policy Engine for managing inter-agent communication rules. The error list, analytics dashboard, and timeline views from the previous navigation are available as collapsible sub-panels. When a Message Archive search returns no results, the panel renders a clear empty state without timing out or raising an exception, while Cost Attribution continues to render independently.

## Primary Actor
Operator

## Supporting Actors
- DashboardLive socket
- ForensicComponents module
- Message Archive component (full-text search over `identity.agent_id`, `meta.trace_id`, `cognition.intent`, `action.tool_call`)
- Cost Attribution component (`state_delta.cumulative_session_cost` from DecisionLog)
- Security panel component (webhook delivery log with signature validation status)
- Policy Engine panel component (Deny/Allow rule management)

## Preconditions
- DashboardLive is mounted with `view_mode: :forensic`.
- The Message Archive backend has DecisionLog event data indexed.
- The operator has the Forensic Inspector view in focus.

## Trigger
The operator enters a search query in the Message Archive search field and submits it.

## Main Success Flow
1. The Forensic Inspector view renders with four panel containers: Message Archive, Cost Attribution, Security, and Policy Engine.
2. The operator types `"agent-abc"` in the Message Archive search field.
3. The operator submits the query (form submit or debounced `phx-change`).
4. `handle_event("search_archive", %{"query" => "agent-abc"}, socket)` is invoked.
5. The backend searches DecisionLog events by `identity.agent_id` matching `"agent-abc"`.
6. Matching events are returned and stored in socket assigns.
7. The Message Archive panel re-renders with the matching events listed.
8. The operator sees all DecisionLog events for `"agent-abc"`.

## Alternate Flows
### A1: Search by meta.trace_id
Condition: The operator enters a trace ID in the search field.
Steps:
1. The query is submitted with `"query" => "trace-001"`.
2. The backend searches `meta.trace_id` for matching events.
3. Matching events are rendered in the archive panel.

### A2: Cost Attribution grouped by Session ID
Condition: The operator selects `"Session ID"` as the grouping dimension.
Steps:
1. A `phx-change` event sets `cost_group_by: :session_id`.
2. The Cost Attribution panel re-renders with cost breakdowns grouped by session.

### A3: Policy Engine â€” add a new Deny rule
Condition: The operator submits a new Deny rule via the Policy Engine panel form.
Steps:
1. `handle_event("add_policy_rule", %{"type" => "deny", "pattern" => "..."}, socket)` is invoked.
2. The new rule is added to the policy set in socket assigns.
3. The Policy Engine panel re-renders with the new rule listed.

### A4: Operator expands the error list collapsible sub-panel
Condition: The operator clicks the expand control for the error list sub-panel.
Steps:
1. A `phx-click` event sets `error_list_open: true`.
2. The error list sub-panel renders inline within the Forensic view.

## Failure Flows
### F1: Message Archive search returns no results
Condition: The search query `"nonexistent-agent"` matches no DecisionLog events.
Steps:
1. The backend returns an empty result list.
2. The archive panel renders: `"No events found."` or equivalent empty state text.
3. No exception is raised; no timeout occurs.
4. The Cost Attribution panel continues to render independently with its current data.
Result: The operator sees a clear empty state in the archive panel; other panels are unaffected.

## Gherkin Scenarios

### S1: Message Archive search returns matching DecisionLog events
```gherkin
Scenario: Operator searches by agent ID and matching events are rendered
  Given the socket assign "view_mode" equals ":forensic"
  And the Message Archive backend contains DecisionLog events for agent "agent-abc"
  When the operator submits a search query with value "agent-abc"
  Then handle_event "search_archive" is invoked with query "agent-abc"
  And the rendered Message Archive panel contains at least one event row for "agent-abc"
```

### S2: Message Archive search with no results renders empty state
```gherkin
Scenario: Search returning no results shows empty state without error
  Given the socket assign "view_mode" equals ":forensic"
  And the Message Archive backend contains no events matching "nonexistent-agent"
  When the operator submits a search query with value "nonexistent-agent"
  Then the rendered Message Archive panel contains the text "No events found"
  And no exception is raised
  And the cost-attribution-panel element is present in the rendered HTML
```

### S3: Cost Attribution re-renders grouped by Session ID
```gherkin
Scenario: Operator switches Cost Attribution grouping to Session ID
  Given the socket assign "view_mode" equals ":forensic"
  And the socket assign "cost_group_by" equals ":agent_id"
  When the operator selects "Session ID" as the grouping dimension
  Then the socket assign "cost_group_by" equals ":session_id"
  And the rendered Cost Attribution panel shows cost breakdowns grouped by session ID
```

## Acceptance Criteria
- [ ] `mix test test/observatory_web/live/dashboard_live_test.exs` passes a test that sends a `search_archive` event with a valid agent ID and asserts matching event rows appear in the rendered archive panel.
- [ ] `mix test test/observatory_web/live/dashboard_live_test.exs` passes a test that sends a `search_archive` event with a query matching no events and asserts an empty-state message is rendered without raising an exception.
- [ ] `mix test test/observatory_web/live/dashboard_live_test.exs` passes a test that sends a cost grouping change event selecting `session_id` as the grouping dimension and asserts the socket assign `cost_group_by` equals `:session_id` and the rendered Cost Attribution panel shows breakdowns grouped by session ID.
- [ ] `mix compile --warnings-as-errors` passes.

## Data
**Inputs:** `search_archive` event with query string; `cost_group_by` change event; `add_policy_rule` form event
**Outputs:** Rendered Message Archive event list or empty state; Cost Attribution grouped breakdown; updated Policy Engine rule list
**State changes:** `archive_results` assign updated with query results; `cost_group_by` assign updated; `policy_rules` assign updated on add/edit/remove.

## Traceability
- Parent FR: FR-12.10
- ADR: [ADR-022](../../decisions/ADR-022-six-view-ui-architecture.md)
