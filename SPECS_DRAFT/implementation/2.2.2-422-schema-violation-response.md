---
type: task
id: "2.2.2"
section_id: "2.2"
title: "422 Schema Violation Response"
status: pending
governed_by: ["ADR-015"]
parent_uc: ["UC-0212"]
---

# Task 2.2.2: 422 Schema Violation Response

## Goal

Ensure the `handle_invalid/3` branch of `GatewayController` produces a well-formed HTTP 422 response with all four required JSON fields. The `detail` field must be derived from changeset errors. `trace_id` must always be `null` in the 422 case. The response status must be 422, not 400 â€” tests assert this distinction explicitly.

## Governing Decisions

- ADR-015

## Verification UCs

- UC-0212

## Subtasks

| ID | Title | Done When | Status |
|----|-------|-----------|--------|
| 2.2.2.a | Verify handle_invalid/3 uses put_status(:unprocessable_entity) and returns correct JSON keys | mix compile --warnings-as-errors | pending |
| 2.2.2.b | Test POST missing identity.agent_id returns HTTP 422 with structured body | mix test test/observatory_web/controllers/gateway_controller_test.exs --only rejection | pending |
| 2.2.2.c | Test schema violation returns 422 not 400 | mix test test/observatory_web/controllers/gateway_controller_test.exs --only rejection | pending |
| 2.2.2.d | Test 422 response body trace_id field is null | mix test test/observatory_web/controllers/gateway_controller_test.exs --only rejection | pending |
