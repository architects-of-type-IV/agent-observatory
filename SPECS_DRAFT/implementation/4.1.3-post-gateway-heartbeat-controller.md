---
type: task
id: "4.1.3"
section_id: "4.1"
title: "POST /gateway/heartbeat Controller"
status: pending
governed_by: ["ADR-019"]
parent_uc: ["UC-0260", "UC-0262"]
---

# Task 4.1.3: POST /gateway/heartbeat Controller

## Goal

Implement the Phoenix controller action and router entry for `POST /gateway/heartbeat`. Validate `type == "heartbeat"`, non-empty `agent_id`, and non-empty `cluster_id`. Upsert the `HeartbeatRecord` via `Repo.insert/2`. Call `HeartbeatManager.record_heartbeat/2`. Rescue GenServer exits from a downed `HeartbeatManager` and return HTTP 503.

## Governing Decisions

- ADR-019

## Verification UCs

- UC-0260
- UC-0262

## Subtasks

| ID | Title | Done When | Status |
|----|-------|-----------|--------|
| 4.1.3.1 | Create heartbeat_controller.ex with create/2 validating type, agent_id, cluster_id returning 422 on failure | mix compile --warnings-as-errors | pending |
| 4.1.3.2 | Implement success path with timestamp parsing, Repo upsert, and HeartbeatManager.record_heartbeat with 503 rescue | mix compile --warnings-as-errors | pending |
| 4.1.3.3 | Add POST /gateway/heartbeat route to router.ex :api pipeline scope | mix compile --warnings-as-errors | pending |
