---
type: task
id: "3.1.1"
section_id: "3.1"
title: "Node Struct & ETS Table Setup"
status: pending
governed_by: ["ADR-017"]
parent_uc: ["UC-0230", "UC-0231"]
---

# Task 3.1.1: Node Struct & ETS Table Setup

## Goal

Define the `%Observatory.Mesh.CausalDAG.Node{}` struct with all nine required fields and implement `CausalDAG.insert/2` for the root and non-orphan paths. Each active session gets its own ETS table created on demand. The function validates field presence before any ETS write and inserts root nodes directly without touching the orphan buffer.

## Governing Decisions

- ADR-017

## Verification UCs

- UC-0230
- UC-0231

## Subtasks

| ID | Title | Done When | Status |
|----|-------|-----------|--------|
| 3.1.1.1 | Create causal_dag.ex with GenServer, Node defstruct, and session registry ETS table | mix compile --warnings-as-errors | pending |
| 3.1.1.2 | Implement insert/2 and handle_call with validate_fields/1 and ensure_session_table/1 | mix compile --warnings-as-errors | pending |
| 3.1.1.3 | Implement root node insert path and child-with-present-parent path with broadcast_delta | mix compile --warnings-as-errors | pending |
| 3.1.1.4 | Write tests for valid insert returning :ok and missing agent_id returning {:error, :missing_fields} | mix test test/observatory/mesh/causal_dag_test.exs | pending |
