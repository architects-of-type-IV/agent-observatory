---
type: task
id: "2.3.1"
section_id: "2.3"
title: "SchemaViolationEvent Construction"
status: pending
governed_by: ["ADR-015"]
parent_uc: ["UC-0213", "UC-0214"]
---

# Task 2.3.1: SchemaViolationEvent Construction

## Goal

Add `Observatory.Gateway.SchemaInterceptor.build_violation_event/3` that takes the changeset, the params map, and the raw body binary (or `nil` when unavailable), and returns a plain Elixir map with exactly six fields. Enforce the security policy: no `"raw_payload"` key, no logging of params, and the hash is always computed and always present.

## Governing Decisions

- ADR-015

## Verification UCs

- UC-0213
- UC-0214

## Subtasks

| ID | Title | Done When | Status |
|----|-------|-----------|--------|
| 2.3.1.a | Implement build_violation_event/3 with HMAC hash and no raw_payload key | mix compile --warnings-as-errors | pending |
| 2.3.1.b | Update handle_invalid/3 in gateway_controller to call build_violation_event/3 | mix compile --warnings-as-errors | pending |
| 2.3.1.c | Test build_violation_event/3 returns map with all six required keys | mix test test/observatory/gateway/schema_interceptor_test.exs --only violation_event | pending |
| 2.3.1.d | Test build_violation_event/3 defaults agent_id to unknown when identity absent | mix test test/observatory/gateway/schema_interceptor_test.exs --only violation_event | pending |
| 2.3.1.e | Test raw_payload_hash starts with sha256: and is 71 characters | mix test test/observatory/gateway/schema_interceptor_test.exs --only violation_event | pending |
| 2.3.1.f | Test build_violation_event/3 does not include raw_payload key | mix test test/observatory/gateway/schema_interceptor_test.exs --only violation_event | pending |
| 2.3.1.g | Test falls back to JSON hash when raw_body is nil | mix test test/observatory/gateway/schema_interceptor_test.exs --only violation_event | pending |
| 2.3.1.h | Test does not log params or raw body during rejection via CaptureLog | mix test test/observatory/gateway/schema_interceptor_test.exs --only violation_event | pending |
