---
type: task
id: "3.1.3"
section_id: "3.1"
title: "Cycle Prevention"
status: pending
governed_by: ["ADR-017"]
parent_uc: ["UC-0233"]
---

# Task 3.1.3: Cycle Prevention

## Goal

Before any non-root node is written to ETS, CausalDAG must walk the ancestor chain of the declared `parent_step_id` upward, checking whether the incoming `trace_id` appears anywhere in that chain. If a match is found, the insertion is aborted and `{:error, :cycle_detected}` is returned with no ETS modification and no broadcast.

## Governing Decisions

- ADR-017

## Verification UCs

- UC-0233

## Subtasks

| ID | Title | Done When | Status |
|----|-------|-----------|--------|
| 3.1.3.1 | Implement detect_cycle/4 private function with 100-hop cap and nil/ETS-miss base cases | mix compile --warnings-as-errors | pending |
| 3.1.3.2 | Call detect_cycle before ETS write for non-root nodes and return {:error, :cycle_detected} on match | mix compile --warnings-as-errors | pending |
| 3.1.3.3 | Write tests for A->B->A cycle detection and clean A->B->C chain acceptance | mix test test/observatory/mesh/causal_dag_test.exs | pending |
