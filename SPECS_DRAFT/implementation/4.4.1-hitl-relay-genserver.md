---
type: task
id: "4.4.1"
section_id: "4.4"
title: "HITLRelay GenServer and State Machine"
status: pending
governed_by: ["ADR-021"]
parent_uc: ["UC-0271", "UC-0273"]
---

# Task 4.4.1: HITLRelay GenServer and State Machine

## Goal

Create `lib/observatory/gateway/hitl_relay.ex`. The GenServer maintains a state map of `%{session_id => :normal | :paused}` and owns an ETS table `:hitl_buffer` with `ordered_set` semantics. Expose public functions `pause/4`, `unpause/3`, `rewrite/5`, and `inject/4`.

## Governing Decisions

- ADR-021

## Verification UCs

- UC-0271
- UC-0273

## Subtasks

| ID | Title | Done When | Status |
|----|-------|-----------|--------|
| 4.4.1.1 | Create hitl_relay.ex with GenServer, :hitl_buffer ordered_set ETS table, and start_link/1 | mix compile --warnings-as-errors | pending |
| 4.4.1.2 | Implement pause/4 with :already_paused guard and HITLGateOpenEvent broadcast | mix compile --warnings-as-errors | pending |
| 4.4.1.3 | Implement unpause/3 with buffer flush, :normal transition, and HITLGateCloseEvent broadcast | mix compile --warnings-as-errors | pending |
| 4.4.1.4 | Add HITLRelay to application supervisor | mix compile --warnings-as-errors | pending |
