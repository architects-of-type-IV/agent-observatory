---
type: task
id: "2.4.1"
section_id: "2.4"
title: "Topology Node State on Violation"
status: pending
governed_by: ["ADR-015", "ADR-016"]
parent_uc: ["UC-0216"]
---

# Task 2.4.1: Topology Node State on Violation

## Goal

Broadcast a topology update on `"gateway:topology"` when a schema violation is processed, setting the offending node state to `:schema_violation`. This broadcast enables the Canvas renderer to apply the orange highlight (`#f97316` per ADR-016). The broadcast must also include a clearance timer instruction so downstream topology subscribers know to revert after 30 seconds.

## Governing Decisions

- ADR-015
- ADR-016

## Verification UCs

- UC-0216

## Subtasks

| ID | Title | Done When | Status |
|----|-------|-----------|--------|
| 2.4.1.a | Update handle_invalid/3 with Task.start broadcasting :node_state_update on gateway:topology | mix compile --warnings-as-errors | pending |
| 2.4.1.b | Test POST invalid payload broadcasts {:node_state_update, update} on gateway:topology | mix test test/observatory_web/controllers/gateway_controller_test.exs --only topology | pending |
| 2.4.1.c | Test topology broadcast state is :schema_violation atom not string | mix test test/observatory_web/controllers/gateway_controller_test.exs --only topology | pending |
| 2.4.1.d | Test topology broadcast does NOT fire on successful validation | mix test test/observatory_web/controllers/gateway_controller_test.exs --only topology | pending |
