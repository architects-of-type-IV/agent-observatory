---
type: task
id: "2.3.2"
section_id: "2.3"
title: "PubSub Broadcast on gateway:violations"
status: pending
governed_by: ["ADR-015"]
parent_uc: ["UC-0215"]
---

# Task 2.3.2: PubSub Broadcast on gateway:violations

## Goal

Add the PubSub broadcast call to the rejection path in `GatewayController`. The broadcast must use `Phoenix.PubSub.broadcast(Observatory.PubSub, "gateway:violations", {:schema_violation, event})`. On broadcast failure, emit a warning log and do not raise. The HTTP 422 response to the agent is never blocked by the broadcast outcome.

## Governing Decisions

- ADR-015

## Verification UCs

- UC-0215

## Subtasks

| ID | Title | Done When | Status |
|----|-------|-----------|--------|
| 2.3.2.a | Update handle_invalid/3 with Task.start PubSub broadcast on gateway:violations | mix compile --warnings-as-errors | pending |
| 2.3.2.b | Test broadcast delivers {:schema_violation, event} to subscribers | mix test test/observatory/gateway/schema_interceptor_test.exs --only pubsub | pending |
| 2.3.2.c | Integration test POST invalid payload broadcasts schema_violation on gateway:violations | mix test test/observatory_web/controllers/gateway_controller_test.exs --only pubsub | pending |
| 2.3.2.d | Test broadcast uses :schema_violation atom not string key | mix test test/observatory/gateway/schema_interceptor_test.exs --only pubsub | pending |
| 2.3.2.e | Test broadcast failure logs warning and does not raise | mix test test/observatory/gateway/schema_interceptor_test.exs --only pubsub | pending |
