---
id: UC-0262
title: Reject Malformed Heartbeat POST
status: draft
parent_fr: FR-10.3
adrs: [ADR-019]
---

# UC-0262: Reject Malformed Heartbeat POST

## Intent
When an HTTP client submits a heartbeat payload with an invalid `type` field or missing required fields, the gateway controller returns HTTP 422 with a descriptive error reason without touching the HeartbeatManager or the `gateway_heartbeats` table.

## Primary Actor
HeartbeatManager

## Supporting Actors
- `POST /gateway/heartbeat` HTTP endpoint
- Phoenix controller validation logic

## Preconditions
- The `POST /gateway/heartbeat` endpoint is mounted and reachable.
- The request body is valid JSON but contains an invalid or missing `type`, `agent_id`, or `cluster_id` field.

## Trigger
An HTTP client sends `POST /gateway/heartbeat` with a JSON body where `type` is not `"heartbeat"` or a required field is absent.

## Main Success Flow
1. The Phoenix controller receives the POST and parses the JSON body.
2. The controller checks that `type == "heartbeat"`.
3. The `type` field fails validation (e.g., `"type": "status_update"`).
4. The controller returns HTTP 422 `{"status": "error", "reason": "invalid_heartbeat_type"}` immediately.
5. `HeartbeatManager.record_heartbeat/2` is never called.
6. No upsert is performed on `gateway_heartbeats`.

## Alternate Flows
### A1: Missing agent_id or cluster_id
Condition: The body has `type: "heartbeat"` but `agent_id` or `cluster_id` is absent or an empty string.
Steps:
1. The controller validates field presence after the type check.
2. Returns HTTP 422 `{"status": "error", "reason": "missing_required_field"}`.
3. HeartbeatManager and database are not touched.

## Failure Flows
### F1: Body Is Not Valid JSON
Condition: The request body cannot be parsed as JSON.
Steps:
1. The JSON parser raises a decode error.
2. The controller or Plug catches it and returns HTTP 400.
Result: The controller does not proceed to field validation. HeartbeatManager is not called.

## Gherkin Scenarios

### S1: Wrong type field rejected with 422
```gherkin
Scenario: Heartbeat POST with wrong type field returns 422
  Given the HeartbeatManager GenServer is running
  When a POST to /gateway/heartbeat is made with body {"type":"status_update","agent_id":"agent-42","cluster_id":"cluster-west","timestamp":"2026-02-22T10:00:00Z"}
  Then the response status is 422
  And the response body is {"status":"error","reason":"invalid_heartbeat_type"}
  And HeartbeatManager.record_heartbeat is not called
  And the gateway_heartbeats table is not modified
```

### S2: Missing agent_id field rejected with 422
```gherkin
Scenario: Heartbeat POST missing agent_id returns 422
  Given the HeartbeatManager GenServer is running
  When a POST to /gateway/heartbeat is made with body {"type":"heartbeat","cluster_id":"cluster-west","timestamp":"2026-02-22T10:00:00Z"}
  Then the response status is 422
  And the response body contains reason "missing_required_field"
```

## Acceptance Criteria
- [ ] `mix test test/observatory_web/controllers/gateway_controller_test.exs` passes a test that a POST /gateway/heartbeat with `type: "status_update"` returns HTTP 422 with reason `invalid_heartbeat_type` and does not call HeartbeatManager.
- [ ] `mix test test/observatory_web/controllers/gateway_controller_test.exs` passes a test that a POST /gateway/heartbeat missing `agent_id` returns HTTP 422.
- [ ] `mix compile --warnings-as-errors` passes.

## Data
**Inputs:** Invalid JSON heartbeat body (wrong `type`, missing fields)
**Outputs:** HTTP 422 with JSON error body
**State changes:** None â€” HeartbeatManager state and `gateway_heartbeats` table are unchanged.

## Traceability
- Parent FR: FR-10.3
- ADR: [ADR-019](../../decisions/ADR-019-heartbeat-leader-election.md)
