---
id: UC-0303
title: Recover from Legacy localStorage view_mode Atom
status: draft
parent_fr: FR-12.4
adrs: [ADR-022]
---

# UC-0303: Recover from Legacy localStorage view_mode Atom

## Intent
When an operator upgrades from the previous seven-tab navigation to the new six-view Hypervisor architecture, their localStorage may contain a legacy `view_mode` string such as `"command"`, `"pipeline"`, or `"agents"`. The client-side hook must detect invalid values and either clear them or push `"fleet_command"` instead. If an older hook version bypasses this guard and pushes the invalid string to the server, the LiveView `handle_event` must catch it with a rescue or catch-all clause, assign `view_mode: :fleet_command`, and emit a warning-level log entry. No `FunctionClauseError` may reach the operator.

## Primary Actor
DashboardLive

## Supporting Actors
- Phoenix LiveView socket
- localStorage hook (client-side, possibly an older version)
- `Logger` module (warning emission)

## Preconditions
- The operator has a `view_mode` value in localStorage from a previous session using the old navigation structure.
- The stored value is one of the legacy atoms: `"command"`, `"pipeline"`, `"agents"`, `"protocols"`, `"feed"`, `"errors"`, `"analytics"`, or `"timeline"`.
- DashboardLive is mounting.

## Trigger
The client-side localStorage hook reads the stored value and attempts to restore it, either by detecting the invalid value and substituting `"fleet_command"`, or by pushing the invalid value directly to the server.

## Main Success Flow
1. DashboardLive `mount/3` assigns `view_mode: :fleet_command`.
2. The client-side hook reads localStorage and finds `"command"`.
3. The hook checks `"command"` against the valid set: `["fleet_command", "session_cluster", "registry", "scheduler", "forensic", "god_mode"]`.
4. `"command"` is not in the valid set.
5. The hook does not push `"command"` to the server. It either clears the localStorage key or writes `"fleet_command"` to it.
6. No `restore_view_mode` event reaches the server with an invalid value.
7. The socket retains `view_mode: :fleet_command`.
8. The operator sees the Fleet Command view.

## Alternate Flows
### A1: Older hook version pushes legacy atom to server
Condition: A browser with a cached, pre-upgrade JavaScript hook pushes `"command"` to the server via `restore_view_mode`.
Steps:
1. `handle_event("restore_view_mode", %{"value" => "command"}, socket)` is invoked.
2. The handler's case clause does not match `"command"` in the valid set.
3. The catch-all clause fires: `_ -> assign(socket, :view_mode, :fleet_command)`.
4. `Logger.warning/1` is called with a message identifying the unrecognized atom `"command"`.
5. The socket assign is set to `view_mode: :fleet_command`.
6. `FleetCommandComponents` renders.
7. No `FunctionClauseError` is raised.

## Failure Flows
### F1: Unguarded handler raises FunctionClauseError
Condition: The `handle_event` for `restore_view_mode` uses direct pattern matching without a catch-all and receives `"command"`.
Steps:
1. No match clause exists for `"command"`.
2. Elixir raises `FunctionClauseError`.
Result: The LiveView process crashes; the operator sees an error page. This is the failure the requirement prevents â€” the catch-all clause MUST exist.

## Gherkin Scenarios

### S1: Client hook detects legacy value and defaults to fleet_command
```gherkin
Scenario: localStorage contains legacy "command" value, hook substitutes fleet_command
  Given localStorage key "view_mode" equals "command"
  When the DashboardLive localStorage hook runs on page load
  Then no "restore_view_mode" event is pushed to the LiveView with value "command"
  And the socket assign "view_mode" remains ":fleet_command"
  And localStorage key "view_mode" equals "fleet_command" or is cleared
```

### S2: Server-side catch-all handles legacy atom pushed by old hook
```gherkin
Scenario: Old hook pushes legacy atom "pipeline" and server catches it gracefully
  Given the DashboardLive socket has view_mode assigned as :fleet_command
  When a "restore_view_mode" event is pushed with value "pipeline"
  Then the socket assign "view_mode" equals ":fleet_command"
  And a warning-level log entry is emitted containing the string "pipeline"
  And no FunctionClauseError is raised
```

### S3: Valid atom from new hook restores correctly
```gherkin
Scenario: localStorage contains valid "scheduler" value from new hook
  Given localStorage key "view_mode" equals "scheduler"
  When the DashboardLive localStorage hook runs on page load
  Then a "restore_view_mode" event is pushed to the LiveView with value "scheduler"
  And the socket assign "view_mode" equals ":scheduler"
```

## Acceptance Criteria
- [ ] `mix test test/observatory_web/live/dashboard_live_test.exs` passes a test that pushes a `restore_view_mode` event with value `"command"` and asserts `view_mode` becomes `:fleet_command` and a warning is logged.
- [ ] `mix test test/observatory_web/live/dashboard_live_test.exs` passes a test that pushes `restore_view_mode` with each legacy atom (`"pipeline"`, `"agents"`, `"protocols"`, `"feed"`, `"errors"`, `"analytics"`, `"timeline"`) and asserts all result in `view_mode: :fleet_command` without raising.
- [ ] `mix test test/observatory_web/live/dashboard_live_test.exs` passes a test that pushes a `restore_view_mode` event with value `"scheduler"` and asserts `view_mode` becomes `:scheduler` without error.
- [ ] `mix compile --warnings-as-errors` passes.

## Data
**Inputs:** `restore_view_mode` event with a legacy atom string value
**Outputs:** `view_mode: :fleet_command` socket assign, warning log entry
**State changes:** Socket assign forced to `view_mode: :fleet_command`; localStorage key cleared or overwritten with `"fleet_command"`.

## Traceability
- Parent FR: FR-12.4
- ADR: [ADR-022](../../decisions/ADR-022-six-view-ui-architecture.md)
