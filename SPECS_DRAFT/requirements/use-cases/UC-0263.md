---
id: UC-0263
title: Upsert Agent Row in gateway_heartbeats Table
status: draft
parent_fr: FR-10.4
adrs: [ADR-019]
---

# UC-0263: Upsert Agent Row in gateway_heartbeats Table

## Intent
The `gateway_heartbeats` table stores exactly one row per agent, always reflecting the most recent heartbeat. Repeated heartbeat posts from the same agent replace the previous row rather than accumulating new rows, keeping the table as a current liveness snapshot rather than a history log.

## Primary Actor
HeartbeatManager

## Supporting Actors
- `gateway_heartbeats` SQLite table
- Ecto.Repo (upsert via `on_conflict: :replace_all`)
- Ecto migration for `gateway_heartbeats` DDL

## Preconditions
- The Ecto migration defining `gateway_heartbeats` with columns `agent_id` (text, primary key), `cluster_id` (text, not null), and `last_seen_at` (datetime, not null) has been applied.
- The Phoenix controller has validated the incoming heartbeat body and called `HeartbeatManager.record_heartbeat/2` successfully.

## Trigger
The gateway controller calls `Ecto.Repo.insert/2` with `on_conflict: :replace_all, conflict_target: :agent_id` after a successful `HeartbeatManager.record_heartbeat/2` call.

## Main Success Flow
1. The controller constructs an Ecto changeset for `gateway_heartbeats` with `agent_id`, `cluster_id`, and `last_seen_at`.
2. The controller calls `Repo.insert(changeset, on_conflict: :replace_all, conflict_target: :agent_id)`.
3. If no row for `agent_id` exists, SQLite inserts a new row.
4. If a row for `agent_id` already exists, SQLite replaces the `cluster_id` and `last_seen_at` columns atomically.
5. After any number of upserts, exactly one row exists for each `agent_id`.

## Alternate Flows
### A1: First Heartbeat for Agent
Condition: No prior row exists in `gateway_heartbeats` for the `agent_id`.
Steps:
1. The upsert inserts a fresh row.
2. The table now contains one row for the agent.

## Failure Flows
### F1: Migration Not Applied
Condition: The `gateway_heartbeats` table does not exist because the Ecto migration has not been run.
Steps:
1. `Repo.insert/2` raises `Ecto.QueryError` referencing a missing table.
2. The controller does not catch this error; the request process crashes.
3. Phoenix returns HTTP 500 to the caller.
Result: The system is not operational until `mix ecto.migrate` is run. The migration must be applied in CI before integration tests.

## Gherkin Scenarios

### S1: Repeated heartbeats produce exactly one row
```gherkin
Scenario: Hundred heartbeats from the same agent produce one row
  Given the gateway_heartbeats table is empty
  When 100 POST /gateway/heartbeat requests are made with agent_id "agent-42" and incrementing timestamps
  Then the gateway_heartbeats table contains exactly 1 row with agent_id "agent-42"
  And that row's last_seen_at equals the timestamp from the 100th request
```

### S2: Migration absent causes query error
```gherkin
Scenario: Missing migration causes Ecto.QueryError on insert
  Given the gateway_heartbeats table does not exist
  When a POST to /gateway/heartbeat is made with a valid body
  Then the controller raises Ecto.QueryError
  And the response status is 500
```

## Acceptance Criteria
- [ ] `mix test test/observatory_web/controllers/gateway_controller_test.exs` passes a test that 100 heartbeat POSTs for `agent_id "agent-42"` result in exactly one row in `gateway_heartbeats` with `last_seen_at` equal to the most recent timestamp.
- [ ] `mix test test/observatory_web/controllers/gateway_controller_test.exs` passes a test that simulates a missing `gateway_heartbeats` table and asserts that a POST to `/gateway/heartbeat` with a valid body results in an HTTP 500 response due to an Ecto.QueryError.
- [ ] `mix compile --warnings-as-errors` passes.

## Data
**Inputs:** `agent_id` (string), `cluster_id` (string), `last_seen_at` (datetime)
**Outputs:** One row per agent in `gateway_heartbeats`, always reflecting the most recent heartbeat
**State changes:** `gateway_heartbeats` row inserted or replaced for the given `agent_id`.

## Traceability
- Parent FR: FR-10.4
- ADR: [ADR-019](../../decisions/ADR-019-heartbeat-leader-election.md)
