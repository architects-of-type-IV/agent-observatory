---
id: UC-0260
title: Record Agent Heartbeat in Memory and Database
status: draft
parent_fr: FR-10.1
adrs: [ADR-019]
---

# UC-0260: Record Agent Heartbeat in Memory and Database

## Intent
An agent posts a heartbeat signal to the Observatory gateway. The HeartbeatManager updates its in-memory state map with the agent's current liveness entry and the gateway controller upserts the corresponding row in the `gateway_heartbeats` SQLite table, confirming receipt to the caller with HTTP 200.

## Primary Actor
HeartbeatManager

## Supporting Actors
- `Observatory.Gateway.HeartbeatManager` GenServer (named process)
- `gateway_heartbeats` SQLite table
- `POST /gateway/heartbeat` HTTP endpoint

## Preconditions
- The `Observatory.Gateway.HeartbeatManager` GenServer is running and registered under its module name.
- The `gateway_heartbeats` table exists (migration applied).
- The caller provides a JSON body with `type`, `agent_id`, `cluster_id`, and `timestamp`.

## Trigger
An agent sends `POST /gateway/heartbeat` with a valid JSON body.

## Main Success Flow
1. The Phoenix controller receives the POST and parses the JSON body.
2. The controller validates that `type == "heartbeat"`, `agent_id` is a non-empty string, and `cluster_id` is a non-empty string.
3. The controller parses the `timestamp` field as an ISO 8601 UTC datetime; if parsing fails, it falls back to `DateTime.utc_now()`.
4. The controller calls `HeartbeatManager.record_heartbeat(agent_id, cluster_id)`.
5. The HeartbeatManager updates its state map: `state = Map.put(state, agent_id, %{last_seen: DateTime.utc_now(), cluster_id: cluster_id})`.
6. The HeartbeatManager returns `:ok` synchronously to the controller.
7. The controller upserts a row in `gateway_heartbeats` via `Ecto.Repo.insert/2` with `on_conflict: :replace_all, conflict_target: :agent_id`, setting `last_seen_at` to the parsed timestamp.
8. The controller returns HTTP 200 `{"status": "ok"}`.

## Alternate Flows
### A1: Timestamp Parse Failure
Condition: The `timestamp` field in the request body is absent or not a valid ISO 8601 string.
Steps:
1. The controller catches the parse error.
2. `last_seen_at` is set to `DateTime.utc_now()`.
3. Processing continues from step 6 of the main flow.

## Failure Flows
### F1: HeartbeatManager Process Not Running
Condition: The `Observatory.Gateway.HeartbeatManager` GenServer has crashed and is not yet restarted when `record_heartbeat/2` is called.
Steps:
1. The call raises a `GenServer` exit.
2. The controller rescues the exit.
3. The controller returns HTTP 503 `{"status": "error", "reason": "heartbeat_manager_unavailable"}`.
Result: The database upsert is not performed. The caller receives a 503 response. No request process crash occurs.

## Gherkin Scenarios

### S1: Successful heartbeat updates memory and database
```gherkin
Scenario: Agent heartbeat recorded in memory and database
  Given the HeartbeatManager GenServer is running
  And the gateway_heartbeats table exists
  When a POST to /gateway/heartbeat is made with body {"type":"heartbeat","agent_id":"agent-42","cluster_id":"cluster-west","timestamp":"2026-02-22T10:00:00Z"}
  Then the response status is 200
  And the response body is {"status":"ok"}
  And HeartbeatManager state contains "agent-42" with cluster_id "cluster-west"
  And gateway_heartbeats has exactly one row for agent_id "agent-42" with last_seen_at "2026-02-22T10:00:00Z"
```

### S2: HeartbeatManager unavailable returns 503
```gherkin
Scenario: HeartbeatManager process not running returns 503
  Given the HeartbeatManager GenServer is not running
  When a POST to /gateway/heartbeat is made with a valid body
  Then the response status is 503
  And the response body is {"status":"error","reason":"heartbeat_manager_unavailable"}
```

### S3: record_heartbeat/2 updates the GenServer in-memory state map
```gherkin
Scenario: record_heartbeat/2 returns :ok and updates the GenServer state map entry
  Given the HeartbeatManager GenServer is running with an empty state map
  When HeartbeatManager.record_heartbeat("agent-1", "sess-abc") is called
  Then the return value is :ok
  And the GenServer state map contains an entry keyed by "agent-1" with a recorded timestamp
```

## Acceptance Criteria
- [ ] `mix test test/observatory_web/controllers/gateway_controller_test.exs` passes a test that a valid POST /gateway/heartbeat returns HTTP 200 and the gateway_heartbeats table contains one row for the submitted agent_id.
- [ ] `mix test test/observatory/gateway/heartbeat_manager_test.exs` passes a test that `record_heartbeat/2` returns `:ok` and updates the GenServer state map.
- [ ] `mix test test/observatory_web/controllers/gateway_controller_test.exs` passes a test that a POST /gateway/heartbeat with the HeartbeatManager stopped returns HTTP 503 with reason `heartbeat_manager_unavailable`.
- [ ] `mix compile --warnings-as-errors` passes.

## Data
**Inputs:** `agent_id` (string), `cluster_id` (string), `timestamp` (ISO 8601 string, optional)
**Outputs:** HTTP 200 `{"status":"ok"}` or HTTP 503 error JSON
**State changes:** HeartbeatManager state map updated; `gateway_heartbeats` row upserted.

## Traceability
- Parent FR: FR-10.1
- ADR: [ADR-019](../../decisions/ADR-019-heartbeat-leader-election.md)
