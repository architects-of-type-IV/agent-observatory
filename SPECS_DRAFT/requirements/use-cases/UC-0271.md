---
id: UC-0271
title: Pause Agent Session via HITL Command
status: draft
parent_fr: FR-11.1
adrs: [ADR-021]
---

# UC-0271: Pause Agent Session via HITL Command

## Intent
An operator sends a `hitl_pause` command to the HITLRelay, transitioning the target session from `Normal` to `Paused` state. Subsequent DecisionLog messages from that session are buffered in ETS rather than forwarded, and a `HITLGateOpenEvent` is broadcast on the per-session PubSub topic so that the LiveView can display the approval gate.

## Primary Actor
HITLRelay

## Supporting Actors
- `Observatory.Gateway.HITLRelay` GenServer
- `:hitl_buffer` ETS table (`ordered_set`)
- PubSub topic `"session:hitl:#{session_id}"`
- `HITLInterventionEvent` Ash resource (audit trail)

## Preconditions
- The HITLRelay GenServer is running.
- The target session `session_id` is in `Normal` state (not previously paused).
- The HTTP request includes the `X-Observatory-Operator-Id` header with a non-empty value.
- The request body contains all required fields: `type`, `session_id`, `agent_id`, `operator_id`, `reason`, `timestamp`.

## Trigger
An operator sends `POST /gateway/sessions/:session_id/pause` with a valid JSON body and valid operator header.

## Main Success Flow
1. The operator authentication plug reads `X-Observatory-Operator-Id` and sets `conn.assigns[:operator_id]`.
2. The Phoenix controller validates the request body fields.
3. The controller calls `HITLRelay.pause(session_id, agent_id, operator_id, reason)`.
4. The HITLRelay looks up the current state for `session_id`; it is `Normal`.
5. The HITLRelay transitions the session to `Paused` state.
6. The HITLRelay initializes an ETS entry at key `{session_id, agent_id}` mapped to an empty list `[]`.
7. The HITLRelay broadcasts `%HITLGateOpenEvent{session_id: session_id, agent_id: agent_id, operator_id: operator_id, reason: reason, timestamp: timestamp}` on `Phoenix.PubSub.broadcast(Observatory.PubSub, "session:hitl:#{session_id}", event)`.
8. A `HITLInterventionEvent` Ash resource row is created with `command_type: :hitl_pause`, `before_state: nil`, `after_state: nil`.
9. The controller returns HTTP 200 `{"status": "ok"}`.

## Alternate Flows
### A1: Session Already Paused
Condition: The session `session_id` is already in `Paused` state when the `hitl_pause` command arrives.
Steps:
1. HITLRelay detects the current state is already `Paused`.
2. It does not reset the buffer or re-broadcast `HITLGateOpenEvent`.
3. The controller returns HTTP 200 `{"status": "ok", "note": "already_paused"}`.

## Failure Flows
### F1: Missing Operator ID Header
Condition: The request does not include the `X-Observatory-Operator-Id` header or the value is blank/whitespace.
Steps:
1. The authentication plug applies `String.trim/1` and detects an empty value.
2. The plug halts the connection and returns HTTP 401 `{"status": "error", "reason": "missing_operator_id"}`.
3. HITLRelay is never called.
Result: The session state is not changed. The operator must resubmit with a valid header.

## Gherkin Scenarios

### S1: Normal session paused successfully
```gherkin
Scenario: Operator pauses a Normal session via POST /gateway/sessions/:session_id/pause
  Given HITLRelay GenServer is running
  And session "sess-abc" is in Normal state
  And the request includes header X-Observatory-Operator-Id: operator-xander
  When a POST to /gateway/sessions/sess-abc/pause is made with valid body {"type":"hitl_pause","session_id":"sess-abc","agent_id":"agent-1","operator_id":"operator-xander","reason":"review_required","timestamp":"2026-02-22T10:00:00Z"}
  Then the response status is 200
  And the response body is {"status":"ok"}
  And session "sess-abc" is now in Paused state in HITLRelay
  And a HITLGateOpenEvent is broadcast on "session:hitl:sess-abc"
  And a HITLInterventionEvent row is created with command_type :hitl_pause
```

### S2: Duplicate pause on already-paused session returns 200 with note
```gherkin
Scenario: Pausing an already-paused session is a no-op
  Given session "sess-abc" is already in Paused state
  When a POST to /gateway/sessions/sess-abc/pause is made with a valid body
  Then the response status is 200
  And the response body contains note "already_paused"
  And the ETS buffer for {"sess-abc","agent-1"} is not reset
```

### S3: Missing operator header rejected with 401
```gherkin
Scenario: Pause request without X-Observatory-Operator-Id header is rejected
  Given HITLRelay GenServer is running
  When a POST to /gateway/sessions/sess-abc/pause is made without the X-Observatory-Operator-Id header
  Then the response status is 401
  And the response body is {"status":"error","reason":"missing_operator_id"}
  And HITLRelay is not called
```

## Acceptance Criteria
- [ ] `mix test test/observatory/gateway/hitl_relay_test.exs` passes a test that `HITLRelay.pause/4` transitions a `Normal` session to `Paused`, broadcasts `HITLGateOpenEvent` on `"session:hitl:#{session_id}"`, and creates a `HITLInterventionEvent` row.
- [ ] `mix test test/observatory/gateway/hitl_relay_test.exs` passes a test that calling pause on an already-paused session returns the `already_paused` note and does not reset the ETS buffer.
- [ ] `mix test test/observatory_web/controllers/gateway_controller_test.exs` passes a test that a pause request without the operator header returns HTTP 401 with reason `missing_operator_id`.
- [ ] `mix compile --warnings-as-errors` passes.

## Data
**Inputs:** `session_id`, `agent_id`, `operator_id`, `reason`, `timestamp`
**Outputs:** HTTP 200; `HITLGateOpenEvent` on PubSub; `HITLInterventionEvent` audit row
**State changes:** HITLRelay session state: `Normal` -> `Paused`; ETS `:hitl_buffer` entry initialized.

## Traceability
- Parent FR: FR-11.1
- ADR: [ADR-021](../../decisions/ADR-021-hitl-intervention-api.md)
