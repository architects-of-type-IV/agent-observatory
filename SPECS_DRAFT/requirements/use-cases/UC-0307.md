---
id: UC-0307
title: Update Agent Traffic Weight via Registry Routing Logic Manager
status: draft
parent_fr: FR-12.8
adrs: [ADR-022]
---

# UC-0307: Update Agent Traffic Weight via Registry Routing Logic Manager

## Intent
The Registry view presents the operator with a Capability Directory of registered agent types and a Routing Logic Manager for adjusting traffic weights and viewing circuit breaker status. The Capability Directory must be sortable by agent type name, instance count, and model version. Submitting a traffic weight change through the Routing Logic Manager sends a `phx-submit` form event to the backend. Invalid weight values (e.g., negative numbers) are rejected by changeset validation with an inline form error, leaving the routing configuration unchanged.

## Primary Actor
Operator

## Supporting Actors
- DashboardLive socket
- RegistryComponents module
- Capability Directory component (sorted by `identity.agent_type`, `identity.capability_version` from DecisionLog)
- Routing Logic Manager form component
- Backend routing configuration changeset

## Preconditions
- DashboardLive is mounted with `view_mode: :registry`.
- The Capability Directory is populated with at least one agent type derived from incoming DecisionLog events.
- The operator has the Registry view in focus.

## Trigger
The operator edits a traffic weight field for an agent type and submits the Routing Logic Manager form.

## Main Success Flow
1. The operator sees the Capability Directory listing agent types (e.g., `"orchestrator"`, `"worker"`, `"planner"`) with their current instance counts and model version distributions.
2. The operator clicks a column header to sort the directory by instance count (descending).
3. The Capability Directory re-renders with rows sorted by instance count.
4. The operator locates the `"worker"` route in the Routing Logic Manager panel.
5. The operator changes the weight field for `"worker"` from `50` to `70`.
6. The operator submits the form.
7. `handle_event("update_route_weight", %{"agent_type" => "worker", "weight" => "70"}, socket)` is invoked.
8. The backend changeset validates `70` as a valid weight value.
9. The routing configuration is updated.
10. The Routing Logic Manager re-renders reflecting the new weight.

## Alternate Flows
### A1: Sort Capability Directory by agent type name
Condition: The operator clicks the `"Agent Type"` column header.
Steps:
1. A `phx-click` or `phx-change` event sets `capability_sort_field: :agent_type` and `capability_sort_dir: :asc`.
2. The directory re-renders with rows sorted alphabetically by agent type name.

### A2: Sort Capability Directory by model version
Condition: The operator clicks the `"Model Version"` column header.
Steps:
1. Sort assigns update to `capability_sort_field: :capability_version`.
2. The directory re-renders sorted by `identity.capability_version` values.

## Failure Flows
### F1: Operator submits a negative traffic weight
Condition: The operator enters `-1` in the weight field and submits the form.
Steps:
1. `handle_event("update_route_weight", %{"agent_type" => "worker", "weight" => "-1"}, socket)` is invoked.
2. The backend changeset validation rejects `-1` (weight must be a non-negative integer).
3. The form changeset error is added: `"Weight must be greater than or equal to 0"`.
4. The Routing Logic Manager form re-renders with the inline validation error message displayed.
5. The routing configuration is not modified.
Result: The operator sees the validation error; the previous weight remains in effect.

## Gherkin Scenarios

### S1: Capability Directory sorts by instance count on column header click
```gherkin
Scenario: Operator sorts Capability Directory by instance count
  Given the socket assign "view_mode" equals ":registry"
  And the Capability Directory contains three agent types with distinct instance counts
  When the operator clicks the "Instance Count" column header
  Then the socket assign "capability_sort_field" equals ":instance_count"
  And the rendered Capability Directory rows are ordered by instance count descending
```

### S2: Valid traffic weight update is accepted and applied
```gherkin
Scenario: Operator submits a valid traffic weight and routing configuration updates
  Given the socket assign "view_mode" equals ":registry"
  And the Routing Logic Manager shows agent type "worker" with weight 50
  When the operator changes the weight field to "70" and submits the form
  Then handle_event "update_route_weight" is invoked with agent_type "worker" and weight "70"
  And the routing configuration reflects weight 70 for "worker"
  And the rendered form does not show a validation error message
```

### S3: Negative traffic weight is rejected with inline validation error
```gherkin
Scenario: Submitting a negative weight shows a validation error and does not update routing
  Given the socket assign "view_mode" equals ":registry"
  And the Routing Logic Manager shows agent type "worker" with weight 50
  When the operator changes the weight field to "-1" and submits the form
  Then the routing configuration for "worker" remains at weight 50
  And the rendered form contains an inline validation error message for the weight field
```

## Acceptance Criteria
- [ ] `mix test test/observatory_web/live/dashboard_live_test.exs` passes a test that sends an `update_route_weight` event with a valid weight and asserts the routing configuration is updated and no form error is rendered.
- [ ] `mix test test/observatory_web/live/dashboard_live_test.exs` passes a test that sends an `update_route_weight` event with weight `"-1"` and asserts the routing configuration is unchanged and an inline form error is rendered.
- [ ] `mix test test/observatory_web/live/dashboard_live_test.exs` passes a test that triggers a sort event on the Capability Directory column header for instance count and asserts the socket assign `capability_sort_field` equals `:instance_count` and the rendered directory rows are ordered by instance count descending.
- [ ] `mix compile --warnings-as-errors` passes.

## Data
**Inputs:** `phx-submit` form event with `agent_type` and `weight` fields; column header click events with sort field
**Outputs:** Updated routing configuration (on valid submission) or inline validation error (on invalid submission); re-sorted Capability Directory
**State changes:** `capability_sort_field` and `capability_sort_dir` assigns updated on sort; routing configuration updated on valid submit; changeset errors set on invalid submit.

## Traceability
- Parent FR: FR-12.8
- ADR: [ADR-022](../../decisions/ADR-022-six-view-ui-architecture.md)
