---
id: UC-0269
title: Re-Queue Undelivered Webhooks on WebhookRouter Startup
status: draft
parent_fr: FR-10.11
adrs: [ADR-020]
---

# UC-0269: Re-Queue Undelivered Webhooks on WebhookRouter Startup

## Intent
When the WebhookRouter GenServer initializes after a restart, it queries the `webhook_deliveries` table for all rows with `status: "pending"` or `status: "failed"` and re-schedules them for delivery. Rows whose `next_retry_at` is already past are dispatched in the first poll cycle; future rows wait until their scheduled time. Dead rows are never re-queued without explicit operator action.

## Primary Actor
WebhookRouter

## Supporting Actors
- `webhook_deliveries` SQLite table
- OTP Supervisor (triggers restart and calls `init/1`)

## Preconditions
- The WebhookRouter GenServer has restarted (crashed or application restart).
- The `webhook_deliveries` table contains rows with `status IN ("pending", "failed")`.
- No rows with `status: "dead"` are re-queued; they require manual operator reset.

## Trigger
`Observatory.Gateway.WebhookRouter.init/1` executes during GenServer startup.

## Main Success Flow
1. The OTP supervisor restarts the WebhookRouter and calls `init/1`.
2. `init/1` queries: `Repo.all(from d in WebhookDelivery, where: d.status in ["pending", "failed"])`.
3. For each returned row:
   a. Computes `due_in_ms = DateTime.diff(row.next_retry_at, DateTime.utc_now(), :millisecond)`.
   b. If `due_in_ms <= 0`: queues the row for immediate dispatch in the first poll cycle.
   c. If `due_in_ms > 0`: the periodic poll will find it naturally when `next_retry_at` becomes due.
4. The GenServer enters its poll loop with `@poll_interval_ms` (default 5000 ms).
5. The first poll dispatches all past-due rows (capped at 5 per cycle).

## Alternate Flows
### A1: No Undelivered Rows
Condition: All `webhook_deliveries` rows have `status: "delivered"` or `status: "dead"`.
Steps:
1. `init/1` queries the table and finds no rows with `status IN ("pending","failed")`.
2. The GenServer starts its poll loop with no immediate dispatch.

## Failure Flows
### F1: Dead Rows Not Re-Queued
Condition: The `webhook_deliveries` table contains rows with `status: "dead"`.
Steps:
1. `init/1` query excludes `status: "dead"` rows by design.
2. Dead rows remain untouched.
3. An operator must manually reset `status: "pending"` and `attempt_count: 0` to re-enable retries.
Result: Dead rows are not dispatched on startup. No automatic retry occurs for dead entries.

## Gherkin Scenarios

### S1: Past-due failed rows dispatched in first poll cycle after restart
```gherkin
Scenario: WebhookRouter restart dispatches past-due failed rows
  Given the webhook_deliveries table contains 3 rows with status "failed" and next_retry_at in the past
  And the WebhookRouter GenServer is restarting
  When WebhookRouter.init/1 executes
  Then all 3 rows are queued for dispatch in the first poll cycle
  And within 5 seconds of startup all 3 delivery attempts are made
```

### S2: Dead rows are not re-queued on restart
```gherkin
Scenario: WebhookRouter restart does not re-queue dead rows
  Given the webhook_deliveries table contains 2 rows with status "dead"
  When WebhookRouter.init/1 executes
  Then neither dead row is dispatched or re-scheduled
  And the rows remain with status "dead" after startup
```

## Acceptance Criteria
- [ ] `mix test test/observatory/gateway/webhook_router_test.exs` passes a test that WebhookRouter `init/1` with past-due `status: "failed"` rows causes those rows to be dispatched in the first poll cycle.
- [ ] `mix test test/observatory/gateway/webhook_router_test.exs` passes a test that `status: "dead"` rows are not dispatched or modified during `init/1`.
- [ ] `mix compile --warnings-as-errors` passes.

## Data
**Inputs:** `webhook_deliveries` rows with `status IN ("pending","failed")` at startup
**Outputs:** Past-due rows dispatched; future rows held for poll; dead rows untouched
**State changes:** None to the database at `init/1` time; dispatch attempts update rows in subsequent poll cycles.

## Traceability
- Parent FR: FR-10.11
- ADR: [ADR-020](../../decisions/ADR-020-webhook-retry-dlq.md)
