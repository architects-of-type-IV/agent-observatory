---
id: UC-0300
title: Mount LiveView with Default Fleet Command View
status: draft
parent_fr: FR-12.1
adrs: [ADR-022]
---

# UC-0300: Mount LiveView with Default Fleet Command View

## Intent
When an operator loads the Observatory dashboard for the first time, or when no localStorage `view_mode` key is present, the LiveView must mount immediately on the `:fleet_command` view without a blank frame. This ensures every operator lands on a coherent, data-populated view regardless of prior session history, and that the mount cycle never crashes due to a missing persisted value.

## Primary Actor
DashboardLive

## Supporting Actors
- Phoenix LiveView socket
- localStorage hook (client-side)
- FleetCommandComponents module

## Preconditions
- The operator navigates to the Observatory dashboard URL.
- No `view_mode` key exists in localStorage (first-time user or cleared storage).
- The LiveView process is starting its mount cycle.

## Trigger
The browser initiates a LiveView WebSocket connection and the server-side `mount/3` callback executes.

## Main Success Flow
1. `DashboardLive.mount/3` executes and assigns `view_mode: :fleet_command` to the socket before any client event fires.
2. The LiveView renders the initial HTML using `FleetCommandComponents` with `view_mode: :fleet_command`.
3. The client-side localStorage hook runs on `phx:page-loading-stop` and finds no stored `view_mode` key.
4. The hook does not push any `restore_view_mode` event to the server.
5. The socket retains `view_mode: :fleet_command` and no further re-render occurs.
6. The operator sees the Fleet Command view immediately upon page load.

## Alternate Flows
### A1: localStorage key exists with a valid atom string
Condition: The client hook finds `"session_cluster"` in localStorage.
Steps:
1. The hook pushes `{"event": "restore_view_mode", "value": "session_cluster"}` to the LiveView.
2. `handle_event("restore_view_mode", %{"value" => "session_cluster"}, socket)` validates `"session_cluster"` is in the valid set.
3. The socket assign updates to `view_mode: :session_cluster`.
4. `SessionClusterComponents` renders the session cluster view.

## Failure Flows
### F1: localStorage hook throws a JavaScript exception
Condition: The localStorage API is unavailable (e.g., private mode restriction in some browsers).
Steps:
1. The try/catch in the client hook captures the exception.
2. The hook does not push any event to the server.
3. The socket retains `view_mode: :fleet_command`.
Result: The operator sees Fleet Command; no LiveView crash occurs; the JavaScript exception is silently swallowed by the hook guard.

## Gherkin Scenarios

### S1: First-time user lands on Fleet Command by default
```gherkin
Scenario: Default view on first load with no localStorage
  Given the operator has no "view_mode" key in localStorage
  When the operator navigates to the Observatory dashboard
  Then the socket assign "view_mode" equals ":fleet_command"
  And the FleetCommandComponents render function is called during the mount cycle
  And no "restore_view_mode" event is received by the LiveView
```

### S2: localStorage key absent does not crash mount
```gherkin
Scenario: Mount completes without error when localStorage is empty
  Given the operator has no "view_mode" key in localStorage
  When the LiveView mount/3 callback executes
  Then the process does not raise a FunctionClauseError
  And the rendered HTML contains the fleet-command view container element
```

## Acceptance Criteria
- [ ] `mix test test/observatory_web/live/dashboard_live_test.exs` passes a test that mounts DashboardLive and asserts `socket.assigns.view_mode == :fleet_command` before any client events are pushed.
- [ ] `mix test test/observatory_web/live/dashboard_live_test.exs` passes a test that mounts DashboardLive with no localStorage key present and asserts the process does not raise a FunctionClauseError and the rendered HTML contains the fleet-command view container element.
- [ ] `mix compile --warnings-as-errors` passes.

## Data
**Inputs:** LiveView mount call, absence of localStorage `view_mode` key
**Outputs:** Socket assign `view_mode: :fleet_command`, rendered FleetCommandComponents HTML
**State changes:** Socket assign initialized to `view_mode: :fleet_command`.

## Traceability
- Parent FR: FR-12.1
- ADR: [ADR-022](../../decisions/ADR-022-six-view-ui-architecture.md)
