---
id: UC-0311
title: Fail Kill-Switch Activation on Single Confirmation Attempt
status: draft
parent_fr: FR-12.11
adrs: [ADR-022]
---

# UC-0311: Fail Kill-Switch Activation on Single Confirmation Attempt

## Intent
This failure UC documents the negative path where the kill-switch double-confirm requirement is not enforced. If a code change or regression allows the pause command to be dispatched after only the first confirmation step, the kill-switch requirement is violated. This UC defines the expected behavior (failure) so that tests can detect and block regressions that would allow single-confirm activation. The pause command MUST NOT fire unless `kill_switch_confirm_step` has reached `:second` and the second confirmation event is received.

## Primary Actor
Operator

## Supporting Actors
- DashboardLive socket
- GodModeComponents module
- `kill_switch_confirm_step` socket assign
- Mesh pause command backend

## Preconditions
- DashboardLive is mounted with `view_mode: :god_mode`.
- `kill_switch_confirm_step` is `nil`.

## Trigger
The operator clicks the kill-switch button and completes only the first confirmation step (does not reach the second confirmation).

## Main Success Flow
This is a failure UC; there is no success path. The system MUST prevent the pause command from firing.

## Alternate Flows
None.

## Failure Flows
### F1: Pause command dispatched after only first confirmation (regression)
Condition: A code defect causes `kill_switch_first_confirm` to dispatch the pause command without waiting for `kill_switch_second_confirm`.
Steps:
1. The operator clicks the kill-switch button: `kill_switch_confirm_step` set to `:first`.
2. The operator clicks `Confirm` in the first modal: `kill_switch_first_confirm` event fires.
3. A defective handler dispatches the pause command immediately from the `:first` step.
Result: The mesh is paused after a single confirmation. This is a VIOLATION of FR-12.11. The test suite must detect and fail this scenario.

### F2: Direct navigation to second confirmation without completing first (bypass attempt)
Condition: An automated agent or malicious actor sends `kill_switch_second_confirm` without first sending `kill_switch_click` and `kill_switch_first_confirm`.
Steps:
1. `handle_event("kill_switch_second_confirm", %{}, socket)` is received when `kill_switch_confirm_step` is `nil` or `:first` (for the bypass case, `nil`).
2. The handler checks `kill_switch_confirm_step` and finds it is not `:second`.
3. The pause command is NOT dispatched.
4. `kill_switch_confirm_step` is reset to `nil`.
Result: The bypass attempt fails; the mesh state is unchanged; no error page is shown.

## Gherkin Scenarios

### S1: First confirmation alone does not dispatch pause (regression guard)
```gherkin
Scenario: Completing only the first confirmation does not activate the kill-switch
  Given the socket assign "view_mode" equals ":god_mode"
  And the socket assign "kill_switch_confirm_step" equals nil
  When the "kill_switch_click" event is sent
  And the "kill_switch_first_confirm" event is sent
  Then the socket assign "kill_switch_confirm_step" equals ":second"
  And the mesh pause command is not dispatched
```

### S2: Second confirmation event sent without first step is rejected
```gherkin
Scenario: Sending kill_switch_second_confirm out of sequence does not dispatch pause
  Given the socket assign "view_mode" equals ":god_mode"
  And the socket assign "kill_switch_confirm_step" equals nil
  When the "kill_switch_second_confirm" event is sent directly (bypassing first step)
  Then the mesh pause command is not dispatched
  And the socket assign "kill_switch_confirm_step" equals nil
```

## Acceptance Criteria
- [ ] `mix test test/observatory_web/live/god_mode_test.exs` passes a test that sends `kill_switch_click` and `kill_switch_first_confirm` in sequence and asserts the mesh pause command is NOT dispatched and `kill_switch_confirm_step` equals `:second`.
- [ ] `mix test test/observatory_web/live/god_mode_test.exs` passes a test that sends `kill_switch_second_confirm` when `kill_switch_confirm_step` is `nil` and asserts the mesh pause command is NOT dispatched.
- [ ] `mix compile --warnings-as-errors` passes.

## Data
**Inputs:** `kill_switch_click`, `kill_switch_first_confirm`, `kill_switch_second_confirm` events (in various incomplete sequences)
**Outputs:** No mesh pause command dispatch; `kill_switch_confirm_step` remains at intermediate step or reset to `nil`
**State changes:** `kill_switch_confirm_step` advances to `:second` after first confirmation but pause command is not dispatched until second confirmation is received.

## Traceability
- Parent FR: FR-12.11
- ADR: [ADR-022](../../decisions/ADR-022-six-view-ui-architecture.md)
