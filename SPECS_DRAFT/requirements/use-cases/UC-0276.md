---
id: UC-0276
title: Automatically Pause Session on control.hitl_required Flag
status: draft
parent_fr: FR-11.9
adrs: [ADR-021]
---

# UC-0276: Automatically Pause Session on control.hitl_required Flag

## Intent
When the SchemaInterceptor processes a DecisionLog where `control.hitl_required == true`, it automatically invokes `HITLRelay.pause/4` before forwarding the log to any downstream PubSub topic. The triggering DecisionLog is placed as the first entry in the ETS buffer, not broadcast ahead of the pause, preventing downstream consumers from acting on an unapproved message.

## Primary Actor
SchemaInterceptor

## Supporting Actors
- `Observatory.Gateway.HITLRelay` (called via `pause/4`)
- `:hitl_buffer` ETS table
- PubSub topic `"session:hitl:#{session_id}"` (HITLGateOpenEvent)

## Preconditions
- The SchemaInterceptor is active and processing validated DecisionLogs.
- The HITLRelay GenServer is running.
- The incoming DecisionLog has `control.hitl_required == true`.
- The target session is in `Normal` state before this log is processed.

## Trigger
The SchemaInterceptor receives a validated DecisionLog with `control.hitl_required == true`.

## Main Success Flow
1. The SchemaInterceptor inspects the validated DecisionLog and reads `control.hitl_required`.
2. The value is `true`.
3. The SchemaInterceptor calls `HITLRelay.pause(session_id, agent_id, operator_id: "system", reason: "hitl_required_flag")`.
4. HITLRelay transitions the session to `Paused` and initializes the ETS buffer.
5. HITLRelay broadcasts `HITLGateOpenEvent` on `"session:hitl:#{session_id}"`.
6. The SchemaInterceptor places the triggering DecisionLog as the first entry in the ETS buffer at `{session_id, agent_id}`.
7. The SchemaInterceptor does not broadcast the DecisionLog on any standard PubSub topic.
8. The Session Drill-down LiveView (subscribed to `"session:hitl:#{session_id}"`) receives the event and displays the approval gate.

## Alternate Flows
### A1: control.hitl_required is nil or false
Condition: The DecisionLog has `control.hitl_required` equal to `nil`, `false`, or the field is absent.
Steps:
1. The SchemaInterceptor skips the automatic pause logic.
2. The DecisionLog is forwarded on its standard PubSub topic immediately.

### A2: Session Already Paused When hitl_required Flag Arrives
Condition: The session is already in `Paused` state when a new DecisionLog with `control.hitl_required == true` arrives.
Steps:
1. The SchemaInterceptor calls `HITLRelay.pause/4`; HITLRelay returns `already_paused` (no-op).
2. The triggering DecisionLog is appended to the existing ETS buffer.
3. No new `HITLGateOpenEvent` is broadcast.

## Failure Flows
### F1: HITLRelay.pause Raises Before Buffer Insertion
Condition: `HITLRelay.pause/4` raises an exception (e.g., GenServer not running).
Steps:
1. The exception propagates out of the SchemaInterceptor.
2. The DecisionLog is not placed in any buffer and is not broadcast.
3. The error is logged at `:error` level.
Result: The DecisionLog is silently dropped. Phase 1 does not provide retry for this failure mode. An `:error` log entry is the only signal.

## Gherkin Scenarios

### S1: DecisionLog with hitl_required triggers automatic pause
```gherkin
Scenario: SchemaInterceptor auto-pauses session on control.hitl_required == true
  Given the SchemaInterceptor is processing DecisionLogs
  And the HITLRelay GenServer is running
  And session "sess-abc" is in Normal state
  When a validated DecisionLog arrives with control.hitl_required true for session "sess-abc" and agent "agent-1"
  Then HITLRelay.pause is called with session_id "sess-abc", agent_id "agent-1", operator_id "system", reason "hitl_required_flag"
  And session "sess-abc" transitions to Paused state
  And the triggering DecisionLog is placed as the first entry in the :hitl_buffer ETS list for {"sess-abc","agent-1"}
  And a HITLGateOpenEvent is broadcast on "session:hitl:sess-abc"
  And the DecisionLog is not broadcast on any standard PubSub topic
```

### S2: DecisionLog with control.hitl_required false is forwarded normally
```gherkin
Scenario: DecisionLog with control.hitl_required false is forwarded without pause
  Given the SchemaInterceptor is processing DecisionLogs
  And session "sess-abc" is in Normal state
  When a validated DecisionLog arrives with control.hitl_required false for session "sess-abc"
  Then HITLRelay.pause is not called
  And the DecisionLog is broadcast on the standard DecisionLog PubSub topic for "sess-abc"
```

## Acceptance Criteria
- [ ] `mix test test/observatory/gateway/hitl_relay_test.exs` passes a test that a DecisionLog with `control.hitl_required: true` causes the SchemaInterceptor to call `HITLRelay.pause/4` before any PubSub broadcast, places the log in the ETS buffer, and broadcasts `HITLGateOpenEvent`.
- [ ] `mix test test/observatory/gateway/hitl_relay_test.exs` passes a test that a DecisionLog with `control.hitl_required: false` is forwarded normally without calling `HITLRelay.pause/4`.
- [ ] `mix compile --warnings-as-errors` passes.

## Data
**Inputs:** Validated DecisionLog with `control.hitl_required` flag
**Outputs:** HITLRelay state change to `Paused`; ETS buffer populated; `HITLGateOpenEvent` broadcast; no standard PubSub broadcast
**State changes:** HITLRelay session state: `Normal` -> `Paused`; ETS buffer initialized with triggering log.

## Traceability
- Parent FR: FR-11.9
- ADR: [ADR-021](../../decisions/ADR-021-hitl-intervention-api.md)
