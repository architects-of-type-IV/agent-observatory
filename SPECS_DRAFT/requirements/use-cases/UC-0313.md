---
id: UC-0313
title: Push Global Instructions to All Agents of a Class
status: draft
parent_fr: FR-12.13
adrs: [ADR-022]
---

# UC-0313: Push Global Instructions to All Agents of a Class

## Intent
The God Mode Global Instructions panel allows the operator to edit the system prompt for a registered agent class and push the update to all currently running instances of that class via PubSub. The editor is pre-populated with the current system prompt on view mount. A single inline confirmation step (lighter than the kill-switch double-confirm) precedes the push. A success or failure banner is displayed after the backend responds. The panel does not auto-save; edits are discarded if the operator navigates away without confirming the push.

## Primary Actor
Operator

## Supporting Actors
- DashboardLive socket
- GodModeComponents module
- Global Instructions editor component
- `instructions_confirm_pending` socket assign (per agent class)
- Phoenix PubSub (dispatch to running agent instances)
- Backend instruction update handler

## Preconditions
- DashboardLive is mounted with `view_mode: :god_mode`.
- The Global Instructions panel is pre-populated with the current system prompt for each registered agent class (fetched on mount).
- `instructions_confirm_pending` is `nil` for all agent classes (no pending confirmation).

## Trigger
The operator edits the system prompt text for agent class `"orchestrator"` and clicks the `Push to all` button.

## Main Success Flow
1. On mount, the Global Instructions panel fetches and pre-populates the current system prompt for each registered agent class, including `"orchestrator"`.
2. The operator edits the system prompt for `"orchestrator"` in the editor.
3. The operator clicks `Push to all` for `"orchestrator"`.
4. `handle_event("push_instructions_intent", %{"agent_class" => "orchestrator"}, socket)` sets `instructions_confirm_pending: "orchestrator"`.
5. An inline confirmation step renders (e.g., a `Confirm push?` prompt with `Confirm` and `Cancel` buttons adjacent to the editor).
6. The operator clicks `Confirm`.
7. `handle_event("push_instructions_confirm", %{"agent_class" => "orchestrator"}, socket)` dispatches the instruction update to all running `"orchestrator"` agents via PubSub.
8. The backend processes the update and returns a success response.
9. A success banner renders: `"Instructions pushed to all orchestrator agents."`.
10. `instructions_confirm_pending` resets to `nil`.
11. The editor content remains as edited (not reverted).

## Alternate Flows
### A1: Operator cancels the inline confirmation
Condition: The operator clicks `Cancel` in the inline confirmation step.
Steps:
1. `handle_event("push_instructions_cancel", %{"agent_class" => "orchestrator"}, socket)` sets `instructions_confirm_pending: nil`.
2. The inline confirmation step dismisses.
3. No instruction update is dispatched.
4. The editor retains the edited text.

### A2: Operator navigates away from God Mode without pushing
Condition: The operator presses key `"1"` to navigate to `:fleet_command` after editing but without clicking `Push to all`.
Steps:
1. `view_mode` changes to `:fleet_command`.
2. GodModeComponents is no longer rendered.
3. The edited instruction text is discarded (not persisted to socket assigns beyond the current editor state).
4. No instruction update is dispatched.
5. No data loss warning is shown (the panel does not auto-save).

### A3: Multiple agent classes — each class has independent push flow
Condition: Two agent classes (`"orchestrator"` and `"worker"`) are listed in the panel.
Steps:
1. The operator edits `"orchestrator"` and pushes it — success banner for `"orchestrator"` renders.
2. The operator edits `"worker"` independently and pushes it — a separate success banner for `"worker"` renders.
3. Each push is independent; confirming one does not affect the other.

## Failure Flows
### F1: Backend returns an error on instruction push
Condition: The PubSub dispatch or backend handler returns an error for `"orchestrator"`.
Steps:
1. The backend returns `{:error, reason}`.
2. A failure banner renders: `"Push failed for orchestrator agents. Please try again."`.
3. `instructions_confirm_pending` resets to `nil`.
4. The editor retains the edited text so the operator can retry.
Result: No agents receive the new instruction; the editor is not cleared; the operator can attempt the push again.

## Gherkin Scenarios

### S1: Operator completes inline confirmation and instructions are pushed
```gherkin
Scenario: Operator edits and confirms push for orchestrator class
  Given the socket assign "view_mode" equals ":god_mode"
  And the Global Instructions panel is pre-populated with the current prompt for "orchestrator"
  And the socket assign "instructions_confirm_pending" equals nil
  When the operator clicks "Push to all" for "orchestrator" triggering "push_instructions_intent"
  Then the socket assign "instructions_confirm_pending" equals "orchestrator"
  And the rendered HTML contains an inline confirmation step for "orchestrator"
  When the operator clicks Confirm triggering "push_instructions_confirm" for "orchestrator"
  Then the instruction update is dispatched via PubSub to all orchestrator agents
  And the rendered HTML contains a success banner for "orchestrator"
  And the socket assign "instructions_confirm_pending" equals nil
```

### S2: Navigating away without pushing discards edit silently
```gherkin
Scenario: Operator navigates away from God Mode without pushing and edit is discarded
  Given the socket assign "view_mode" equals ":god_mode"
  And the operator has edited the system prompt for "orchestrator" in the editor
  And the socket assign "instructions_confirm_pending" equals nil
  When the operator presses key "1" to navigate to ":fleet_command"
  Then the socket assign "view_mode" equals ":fleet_command"
  And no instruction update is dispatched via PubSub
  And no data loss warning is displayed
```

### S3: Backend failure results in failure banner without clearing editor
```gherkin
Scenario: Backend error on push shows failure banner and preserves edited text
  Given the socket assign "view_mode" equals ":god_mode"
  And the socket assign "instructions_confirm_pending" equals "orchestrator"
  When the "push_instructions_confirm" event is sent and the backend returns an error
  Then the rendered HTML contains a failure banner for "orchestrator"
  And the socket assign "instructions_confirm_pending" equals nil
  And the Global Instructions editor for "orchestrator" still contains the edited text
```

## Acceptance Criteria
- [ ] `mix test test/observatory_web/live/god_mode_test.exs` passes a test that sends `push_instructions_intent` and `push_instructions_confirm` in sequence for an agent class and asserts the PubSub dispatch is called and a success banner is rendered.
- [ ] `mix test test/observatory_web/live/god_mode_test.exs` passes a test that sends `push_instructions_intent` followed by a navigation key event (view_mode change) and asserts no instruction update is dispatched.
- [ ] `mix test test/observatory_web/live/god_mode_test.exs` passes a test that simulates a backend error on `push_instructions_confirm` and asserts a failure banner is rendered and `instructions_confirm_pending` is reset to `nil`.
- [ ] `mix compile --warnings-as-errors` passes.

## Data
**Inputs:** `push_instructions_intent` event with `agent_class`; `push_instructions_confirm` event; `push_instructions_cancel` event; editor text content; backend success/error response
**Outputs:** PubSub instruction dispatch (on confirmed push), success or failure banner, `instructions_confirm_pending` state reset
**State changes:** `instructions_confirm_pending` set to agent class name on intent, reset to `nil` on confirm/cancel; editor content retained on cancel or failure; discarded on navigation without push.

## Traceability
- Parent FR: FR-12.13
- ADR: [ADR-022](../../decisions/ADR-022-six-view-ui-architecture.md)
