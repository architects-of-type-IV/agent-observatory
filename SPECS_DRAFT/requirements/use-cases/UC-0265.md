---
id: UC-0265
title: Recover One-Time Cron Job After Scheduler Restart
status: draft
parent_fr: FR-10.6
adrs: [ADR-019]
---

# UC-0265: Recover One-Time Cron Job After Scheduler Restart

## Intent
When the CronScheduler GenServer restarts after a crash, it reads all unfinished `cron_jobs` rows — including one-time jobs that have not yet fired — and re-schedules them. Jobs whose `next_fire_at` is already past are dispatched immediately, preventing silent job loss across process restarts.

## Primary Actor
CronScheduler

## Supporting Actors
- `cron_jobs` SQLite table
- PubSub topic `"agent:#{agent_id}:scheduled"`
- OTP Supervisor (triggers restart)

## Preconditions
- The CronScheduler GenServer has previously crashed or been restarted.
- The `cron_jobs` table contains at least one row with `is_one_time: true` and `next_fire_at` in the past (the job had not fired before the crash).

## Trigger
`Observatory.Gateway.CronScheduler.init/1` executes as part of GenServer startup.

## Main Success Flow
1. The OTP supervisor restarts the CronScheduler and calls `init/1`.
2. `init/1` queries all rows from `cron_jobs` using `Repo.all(CronJob)`.
3. For each row:
   a. If `next_fire_at` is in the past: sends `{:fire_job, job_id}` to self immediately via `Process.send(self(), {:fire_job, job_id})`.
   b. If `next_fire_at` is in the future: schedules with `Process.send_after(self(), {:fire_job, job_id}, delay_ms)` where `delay_ms` is the remaining time.
4. The GenServer enters its main loop.
5. On each `{:fire_job, job_id}` receipt:
   a. Fetches the job row to confirm it still exists (guard against duplicate fire).
   b. Broadcasts the payload on `"agent:#{agent_id}:scheduled"`.
   c. For `is_one_time: true` rows: deletes the row from `cron_jobs`.
   d. For `is_one_time: false` rows: updates `next_fire_at` to the next scheduled time.

## Alternate Flows
### A1: No Unfinished Jobs on Restart
Condition: The `cron_jobs` table is empty or all rows are for future jobs.
Steps:
1. `init/1` queries the table and finds no past-due rows.
2. Future rows are re-scheduled with appropriate timers.
3. The GenServer starts without immediate dispatch.

## Failure Flows
### F1: Duplicate Fire After Recovery
Condition: The process crashed between broadcasting the payload and deleting the `cron_jobs` row; on restart, the row is still present and past-due.
Steps:
1. `init/1` re-schedules the job.
2. The job fires again, broadcasting the payload a second time.
3. The row is deleted after the second broadcast.
Result: The payload is delivered twice (at-least-once semantics). Phase 1 does not prevent this; callers must be idempotent.

## Gherkin Scenarios

### S1: Past-due one-time job fires on restart
```gherkin
Scenario: CronScheduler restart fires past-due one-time job immediately
  Given the cron_jobs table contains a row with is_one_time true and next_fire_at 10 seconds in the past for agent_id "agent-7"
  And the CronScheduler GenServer is restarting
  When CronScheduler.init/1 executes
  Then the job payload is broadcast on "agent:agent-7:scheduled" within the first poll cycle
  And the cron_jobs row for agent_id "agent-7" is deleted
```

### S2: Future one-time job is re-scheduled on restart
```gherkin
Scenario: CronScheduler restart re-schedules future one-time job
  Given the cron_jobs table contains a row with is_one_time true and next_fire_at 60 seconds in the future for agent_id "agent-8"
  When CronScheduler.init/1 executes
  Then no immediate broadcast occurs for "agent:agent-8:scheduled"
  And after 60 seconds the payload is broadcast on "agent:agent-8:scheduled"
```

## Acceptance Criteria
- [ ] `mix test test/observatory/gateway/cron_scheduler_test.exs` passes a test that restarting the CronScheduler with a past-due `cron_jobs` row causes the payload to be broadcast within one poll cycle and the row to be deleted.
- [ ] `mix test test/observatory/gateway/cron_scheduler_test.exs` passes a test that restarts the CronScheduler with a `cron_jobs` row whose `next_fire_at` is 60 seconds in the future and asserts no immediate broadcast occurs on `"agent:agent-8:scheduled"` during the init cycle.
- [ ] `mix compile --warnings-as-errors` passes.

## Data
**Inputs:** `cron_jobs` table rows (is_one_time, agent_id, next_fire_at, payload)
**Outputs:** PubSub broadcast for past-due jobs; re-scheduled timers for future jobs
**State changes:** Past-due one-time `cron_jobs` rows deleted after firing; recurring rows updated with new `next_fire_at`.

## Traceability
- Parent FR: FR-10.6
- ADR: [ADR-019](../../decisions/ADR-019-heartbeat-leader-election.md)
