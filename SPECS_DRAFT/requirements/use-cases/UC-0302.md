---
id: UC-0302
title: Dismiss Drill-Down or Return to Fleet Command via Escape Key
status: draft
parent_fr: FR-12.3
adrs: [ADR-022]
---

# UC-0302: Dismiss Drill-Down or Return to Fleet Command via Escape Key

## Intent
The `Escape` key serves a two-level navigation purpose: first it closes any open drill-down panel within the current view, and second (when no drill-down is open and the current view is not `:fleet_command`) it navigates back to `:fleet_command`. This gives the operator a single predictable escape hatch that is always safe to press. When already on `:fleet_command` with no drill-down open, `Escape` is a no-op that produces no socket update and no re-render.

## Primary Actor
Operator

## Supporting Actors
- DashboardLive socket
- `phx-window-keydown` event binding (or equivalent client hook)
- localStorage hook
- `selected_session_id`, `inspected_agent_id`, `drill_down_open` socket assigns

## Preconditions
- DashboardLive is mounted and connected via WebSocket.
- The operator has keyboard focus on the page.
- `view_mode` is any valid atom.
- A drill-down panel may or may not be open (indicated by a non-nil `selected_session_id`, `inspected_agent_id`, or `drill_down_open: true`).

## Trigger
The operator presses the `"Escape"` key.

## Main Success Flow
1. The browser fires a `keydown` event with `key: "Escape"`.
2. The LiveView receives `handle_event("keydown", %{"key" => "Escape"}, socket)`.
3. The handler inspects socket assigns: `selected_session_id` is non-nil (a causal DAG drill-down is open on `:session_cluster`).
4. The handler clears `selected_session_id` by assigning `nil`.
5. `view_mode` remains `:session_cluster` — unchanged.
6. The drill-down panel is removed from the rendered HTML; the session list is visible again.
7. localStorage is not updated (view_mode did not change).

## Alternate Flows
### A1: No drill-down open, current view is not :fleet_command
Condition: `selected_session_id`, `inspected_agent_id`, and `drill_down_open` are all nil/false; `view_mode` is `:forensic`.
Steps:
1. Handler finds no open drill-down.
2. Handler sets `view_mode: :fleet_command`.
3. localStorage is updated to `"fleet_command"`.
4. `FleetCommandComponents` renders.

### A2: Both conditions — drill-down open on non-fleet-command view, second Escape press
Condition: The operator pressed Escape once to close the drill-down (from the Main Success Flow), and now presses Escape again. `view_mode` is still `:session_cluster`, no drill-down is open.
Steps:
1. Handler finds no open drill-down.
2. Handler sets `view_mode: :fleet_command`.
3. localStorage updates to `"fleet_command"`.
4. `FleetCommandComponents` renders.

### A3: drill_down_open assign used instead of selected_session_id
Condition: `drill_down_open: true` is set on the socket (e.g., from a topology map node drill-down).
Steps:
1. Handler detects `drill_down_open: true`.
2. Handler assigns `drill_down_open: false`.
3. `view_mode` remains unchanged.
4. The drill-down overlay is dismissed.

## Failure Flows
### F1: Escape pressed on :fleet_command with no drill-down open
Condition: `view_mode: :fleet_command`, `selected_session_id: nil`, `inspected_agent_id: nil`, `drill_down_open: false`.
Steps:
1. Handler inspects assigns — no drill-down open, already on `:fleet_command`.
2. Handler returns the socket unchanged (no `assign` call).
Result: No socket diff is pushed to the client; no re-render occurs; no error is logged.

## Gherkin Scenarios

### S1: Escape dismisses open drill-down without changing view
```gherkin
Scenario: Escape clears drill-down panel and stays on current view
  Given the socket assign "view_mode" equals ":session_cluster"
  And the socket assign "selected_session_id" equals "sess-abc-123"
  When the operator presses "Escape" triggering a keydown event on the window
  Then the socket assign "selected_session_id" equals nil
  And the socket assign "view_mode" remains ":session_cluster"
  And localStorage key "view_mode" is not updated
```

### S2: Escape navigates to Fleet Command when no drill-down is open
```gherkin
Scenario: Escape returns to Fleet Command from a non-default view with no drill-down
  Given the socket assign "view_mode" equals ":forensic"
  And the socket assign "selected_session_id" equals nil
  And the socket assign "drill_down_open" equals false
  When the operator presses "Escape" triggering a keydown event on the window
  Then the socket assign "view_mode" equals ":fleet_command"
  And localStorage key "view_mode" equals "fleet_command"
```

### S3: Escape is a no-op on Fleet Command with no drill-down
```gherkin
Scenario: Escape on Fleet Command with no drill-down produces no state change
  Given the socket assign "view_mode" equals ":fleet_command"
  And the socket assign "selected_session_id" equals nil
  And the socket assign "drill_down_open" equals false
  When the operator presses "Escape" triggering a keydown event on the window
  Then no socket assigns are changed
  And no re-render diff is pushed to the client
```

## Acceptance Criteria
- [ ] `mix test test/observatory_web/live/dashboard_live_test.exs` passes a test that sets `selected_session_id` to a non-nil value, sends `keydown` `"Escape"`, and asserts `selected_session_id` becomes nil while `view_mode` is unchanged.
- [ ] `mix test test/observatory_web/live/dashboard_live_test.exs` passes a test that sets `view_mode: :forensic` with no drill-down open, sends `keydown` `"Escape"`, and asserts `view_mode` becomes `:fleet_command`.
- [ ] `mix test test/observatory_web/live/dashboard_live_test.exs` passes a test that starts on `:fleet_command` with no drill-down, sends `keydown` `"Escape"`, and asserts no socket assigns change.
- [ ] `mix compile --warnings-as-errors` passes.

## Data
**Inputs:** Keyboard `keydown` event with key value `"Escape"`, current socket assigns
**Outputs:** Cleared drill-down assign or updated `view_mode: :fleet_command`, optional localStorage write
**State changes:** `selected_session_id`, `inspected_agent_id`, or `drill_down_open` cleared to nil/false; OR `view_mode` updated to `:fleet_command` with localStorage write; OR no change.

## Traceability
- Parent FR: FR-12.3
- ADR: [ADR-022](../../decisions/ADR-022-six-view-ui-architecture.md)
