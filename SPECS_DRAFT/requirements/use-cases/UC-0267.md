---
id: UC-0267
title: Validate Inbound Webhook Signature and Route Delivery
status: draft
parent_fr: FR-10.10
adrs: [ADR-020]
---

# UC-0267: Validate Inbound Webhook Signature and Route Delivery

## Intent
When an external service delivers an inbound webhook to the Observatory, the gateway controller validates the HMAC-SHA256 signature in the `X-Observatory-Signature` header using a timing-safe comparison. A valid signature causes a `webhook_deliveries` row to be created with `status: "pending"`. An invalid signature returns HTTP 401 and broadcasts a `WebhookSignatureFailureEvent` on the `"gateway:webhooks"` PubSub topic.

## Primary Actor
WebhookRouter

## Supporting Actors
- `POST /gateway/webhooks/:webhook_id` HTTP endpoint
- `webhook_configs` SQLite table (provides shared secret)
- `webhook_deliveries` SQLite table
- PubSub topic `"gateway:webhooks"`

## Preconditions
- The `webhook_configs` table contains a row for `webhook_id` with a non-empty `shared_secret`.
- The `webhook_deliveries` table exists with the required schema and compound index on `(status, next_retry_at)`.
- The caller provides the `X-Observatory-Signature` header in the format `sha256={hex_digest}`.

## Trigger
An external service sends `POST /gateway/webhooks/:webhook_id` with a JSON payload and an `X-Observatory-Signature` header.

## Main Success Flow
1. The Phoenix controller receives the POST and extracts the raw request body before JSON parsing.
2. The controller reads the `shared_secret` for `webhook_id` from `webhook_configs`.
3. The controller computes the expected HMAC-SHA256 digest: `:crypto.mac(:hmac, :sha256, secret, raw_body)` and hex-encodes the result.
4. The controller extracts the submitted digest from the `X-Observatory-Signature` header (stripping the `sha256=` prefix).
5. `Plug.Crypto.secure_compare/2` compares the computed and submitted digests.
6. The comparison returns true.
7. The controller creates a `webhook_deliveries` row with `status: "pending"`, `attempt_count: 0`, `signature` (the computed digest), `created_at: DateTime.utc_now()`, and `next_retry_at` set to 30 seconds from `created_at`.
8. The controller returns HTTP 200 `{"status": "ok"}`.

## Alternate Flows
### A1: webhook_id Not Found in webhook_configs
Condition: No row exists in `webhook_configs` for the given `webhook_id` path parameter.
Steps:
1. The controller cannot retrieve a `shared_secret`.
2. The controller returns HTTP 404 `{"status": "error", "reason": "webhook_not_found"}`.
3. No `webhook_deliveries` row is created.

## Failure Flows
### F1: Signature Mismatch
Condition: `Plug.Crypto.secure_compare/2` returns false (tampered body or wrong secret).
Steps:
1. The controller does not create a `webhook_deliveries` row.
2. The controller broadcasts a `%WebhookSignatureFailureEvent{webhook_id: webhook_id}` on `Phoenix.PubSub.broadcast(Observatory.PubSub, "gateway:webhooks", event)`.
3. The controller returns HTTP 401 `{"status": "error", "reason": "signature_mismatch"}`.
Result: No delivery is queued; the failure event is logged on PubSub.

## Gherkin Scenarios

### S1: Valid signature creates pending delivery row
```gherkin
Scenario: Inbound webhook with valid HMAC-SHA256 signature creates delivery row
  Given webhook_configs has a row for webhook_id 7 with a known shared_secret
  And the webhook_deliveries table is empty
  When a POST to /gateway/webhooks/7 is made with a valid payload and X-Observatory-Signature header matching sha256(payload, shared_secret)
  Then the response status is 200
  And the response body is {"status":"ok"}
  And a webhook_deliveries row is created with webhook_id 7, status "pending", and attempt_count 0
```

### S2: Invalid signature returns 401 and broadcasts failure event
```gherkin
Scenario: Inbound webhook with tampered body returns 401 and broadcasts WebhookSignatureFailureEvent
  Given webhook_configs has a row for webhook_id 7 with a known shared_secret
  When a POST to /gateway/webhooks/7 is made with a payload whose body differs from the signed content
  Then Plug.Crypto.secure_compare returns false
  And the response status is 401
  And the response body is {"status":"error","reason":"signature_mismatch"}
  And a WebhookSignatureFailureEvent is broadcast on the "gateway:webhooks" PubSub topic with webhook_id 7
  And no webhook_deliveries row is created
```

## Acceptance Criteria
- [ ] `mix test test/observatory_web/controllers/gateway_controller_test.exs` passes a test that a POST to `/gateway/webhooks/:webhook_id` with a correct HMAC-SHA256 signature returns HTTP 200 and creates a `webhook_deliveries` row with `status: "pending"`.
- [ ] `mix test test/observatory_web/controllers/gateway_controller_test.exs` passes a test that a POST with a mismatched signature returns HTTP 401 with reason `signature_mismatch` and broadcasts `WebhookSignatureFailureEvent` on `"gateway:webhooks"`.
- [ ] `mix compile --warnings-as-errors` passes.

## Data
**Inputs:** Raw request body, `X-Observatory-Signature` header, `webhook_id` path param, `webhook_configs` shared_secret
**Outputs:** HTTP 200 with delivery row created, or HTTP 401 with PubSub failure event
**State changes:** `webhook_deliveries` row inserted on success (none on failure).

## Traceability
- Parent FR: FR-10.10
- ADR: [ADR-020](../../decisions/ADR-020-webhook-retry-dlq.md)
