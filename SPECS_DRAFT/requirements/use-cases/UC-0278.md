---
id: UC-0278
title: Render Diamond DAG Node for HITL Intervention in Session Drill-down
status: draft
parent_fr: FR-11.11
adrs: [ADR-021]
---

# UC-0278: Render Diamond DAG Node for HITL Intervention in Session Drill-down

## Intent
The Session Drill-down LiveView queries `HITLInterventionEvent` rows associated with a session and renders each intervention as a diamond-shaped DAG node positioned at the timestamp when the pause occurred. Multiple interventions within the same pause window are grouped into a single diamond node with a count badge. The diamond node is visually distinct from standard rectangular DecisionLog nodes and circular terminal nodes.

## Primary Actor
Operator

## Supporting Actors
- Session Drill-down LiveView
- `HITLInterventionEvent` Ash resource (read action)
- Causal DAG rendering component

## Preconditions
- The Session Drill-down LiveView is mounted for a session that has at least one `HITLInterventionEvent` record.
- The LiveView has received the ordered list of forwarded DecisionLog nodes for the session.
- The `HITLInterventionEvent` rows have non-nil `timestamp` fields.

## Trigger
The Session Drill-down LiveView mounts or receives a `HITLGateCloseEvent`, causing it to refresh the causal DAG with intervention data.

## Main Success Flow
1. The LiveView queries `HITLInterventionEvent` rows for the session via the Ash resource read action, ordered by `timestamp`.
2. The LiveView builds the causal DAG node list from forwarded DecisionLog events.
3. For each `HITLInterventionEvent` timestamp, the LiveView inserts a diamond node between the last forwarded DecisionLog before the pause and the first forwarded DecisionLog after the unpause.
4. The diamond node's DAG position is derived from `HITLInterventionEvent.timestamp`, not from the post-unpause DecisionLog's timestamp.
5. The diamond node displays `operator_id`, `command_type`, and `timestamp` as tooltip or inline label content.
6. The diamond node is rendered using a visually distinct shape (diamond, `<>` polygon) compared to rectangular DecisionLog nodes and circular terminal nodes.

## Alternate Flows
### A1: Multiple Interventions at Same Pause Window
Condition: A single pause window contains more than one `HITLInterventionEvent` (e.g., `hitl_pause` followed by `hitl_rewrite`).
Steps:
1. The LiveView groups all `HITLInterventionEvent` rows within the same pause window (time range between pause timestamp and unpause timestamp).
2. All grouped events are rendered as a single diamond node.
3. The diamond node displays a count badge (e.g., "2 interventions").
4. Clicking or hovering the node reveals the full list of grouped intervention events.

### A2: No Interventions for Session
Condition: The session has no `HITLInterventionEvent` rows.
Steps:
1. The LiveView builds the causal DAG with only rectangular DecisionLog nodes and circular terminal nodes.
2. No diamond nodes are rendered.

## Failure Flows
### F1: Diamond Node Placed After Post-Unpause Log
Condition: The DAG position computation uses the post-unpause DecisionLog's timestamp instead of the `HITLInterventionEvent.timestamp`.
Steps:
1. The diamond node is rendered after the first post-unpause DecisionLog rather than between the pre-pause and post-unpause nodes.
2. The visual timeline misrepresents when the intervention occurred.
Result: Incorrect visual representation. The LiveView MUST derive DAG position from `HITLInterventionEvent.timestamp`. This is a correctness requirement, not a visual preference.

## Gherkin Scenarios

### S1: Single intervention diamond between pre-pause and post-unpause nodes
```gherkin
Scenario: Session DAG renders diamond node between pre-pause and post-unpause DecisionLog nodes
  Given session "sess-abc" has forwarded DecisionLogs T1, T2, T3 (before pause) and T3_rewritten (after unpause)
  And one HITLInterventionEvent with command_type :hitl_rewrite at timestamp T_intervention exists for "sess-abc"
  When the Session Drill-down LiveView renders the causal DAG
  Then the node order is: rect(T1), rect(T2), rect(T3), diamond(1 intervention), rect(T3_rewritten)
  And the diamond node tooltip displays operator_id and command_type :hitl_rewrite
```

### S2: Multiple interventions at same pause window grouped into one diamond with count badge
```gherkin
Scenario: Two interventions at same pause window render as single diamond node with count 2
  Given session "sess-abc" has two HITLInterventionEvent rows within the same pause window: hitl_pause and hitl_rewrite
  When the Session Drill-down LiveView renders the causal DAG
  Then exactly one diamond node is rendered between the pre-pause and post-unpause DecisionLog nodes
  And the diamond node displays a count badge of 2
```

## Acceptance Criteria
- [ ] `mix test test/observatory_web/controllers/gateway_controller_test.exs` passes a test that the Session Drill-down LiveView renders a diamond-shaped DAG node between the last pre-pause and first post-unpause DecisionLog nodes when a `HITLInterventionEvent` exists for the session, with the node position derived from `HITLInterventionEvent.timestamp`.
- [ ] `mix test test/observatory_web/controllers/gateway_controller_test.exs` passes a test that two `HITLInterventionEvent` rows in the same pause window are grouped into a single diamond node with a count badge of 2.
- [ ] `mix compile --warnings-as-errors` passes.

## Data
**Inputs:** `HITLInterventionEvent` rows for session (operator_id, command_type, timestamp); ordered forwarded DecisionLog list
**Outputs:** Causal DAG with diamond node(s) at correct positions; tooltip/label content per node; count badge for grouped interventions
**State changes:** Read-only; no state changes (display only).

## Traceability
- Parent FR: FR-11.11
- ADR: [ADR-021](../../decisions/ADR-021-hitl-intervention-api.md)
