---
id: UC-0274
title: Validate Required Fields for All Four HITL Command Types
status: draft
parent_fr: FR-11.4
adrs: [ADR-021]
---

# UC-0274: Validate Required Fields for All Four HITL Command Types

## Intent
The Phoenix controller validates the request body for each of the four HITL command types before calling HITLRelay. Any command missing a required field or carrying an unrecognized `type` value is rejected with HTTP 422 at the controller layer, ensuring HITLRelay is never called with incomplete or malformed input.

## Primary Actor
HITLRelay

## Supporting Actors
- `POST /gateway/sessions/:session_id/pause` controller
- `POST /gateway/sessions/:session_id/unpause` controller
- `POST /gateway/sessions/:session_id/rewrite` controller
- `POST /gateway/sessions/:session_id/inject` controller

## Preconditions
- The four HITL HTTP endpoints are mounted and reachable.
- The operator authentication plug has passed (valid `X-Observatory-Operator-Id` header).
- The request body is valid JSON.

## Trigger
An HTTP client sends a POST to one of the four HITL endpoints with an incomplete or invalid body.

## Main Success Flow
1. The controller receives the POST and parses the JSON body.
2. The controller validates that `type` is one of `"hitl_pause"`, `"hitl_rewrite"`, `"hitl_inject"`, `"hitl_unpause"`.
3. The controller validates all required fields for the detected command type:
   - `hitl_pause`: `type`, `session_id`, `agent_id`, `operator_id`, `reason`, `timestamp`
   - `hitl_rewrite`: `type`, `session_id`, `agent_id`, `original_trace_id`, `new_content`, `operator_id`, `timestamp`
   - `hitl_inject`: `type`, `session_id`, `agent_id`, `prompt`, `operator_id`, `timestamp`
   - `hitl_unpause`: `type`, `session_id`, `agent_id`, `operator_id`, `timestamp`
4. All required fields are present and non-empty.
5. The controller calls the appropriate HITLRelay function.
6. The controller returns HTTP 200 `{"status": "ok"}` on success.

## Alternate Flows
### A1: hitl_inject with Session in Normal State
Condition: A `hitl_inject` command arrives and the session is in `Normal` state (not paused).
Steps:
1. Validation passes.
2. HITLRelay constructs a synthetic DecisionLog from the `prompt` field.
3. HITLRelay broadcasts the synthetic message immediately on the standard DecisionLog topic without buffering.
4. The controller returns HTTP 200.

### A2: hitl_inject with Session in Paused State
Condition: A `hitl_inject` command arrives and the session is in `Paused` state.
Steps:
1. Validation passes.
2. HITLRelay constructs a synthetic DecisionLog from the `prompt` field.
3. HITLRelay appends the synthetic message to the ETS buffer for `{session_id, agent_id}`.
4. The synthetic message will be flushed in order during unpause.
5. The controller returns HTTP 200.

## Failure Flows
### F1: Missing Required Field
Condition: The request body is missing one or more required fields for the command type.
Steps:
1. The controller detects the missing field during validation.
2. The controller returns HTTP 422 `{"status": "error", "reason": "missing_required_field: #{field_name}"}`.
3. HITLRelay is never called.
Result: No state change in HITLRelay or ETS. The operator must resubmit with complete fields.

### F2: Unknown Command Type
Condition: The `type` field in the request body is not one of the four recognized values.
Steps:
1. The controller cannot match the `type` value to a known command.
2. The controller returns HTTP 422 `{"status": "error", "reason": "unknown_command_type"}`.
3. HITLRelay is never called.
Result: No state change. The client receives a 422 response.

## Gherkin Scenarios

### S1: hitl_rewrite missing original_trace_id returns 422
```gherkin
Scenario: hitl_rewrite command missing original_trace_id is rejected at the controller
  Given the operator authentication plug has passed
  When a POST to /gateway/sessions/sess-abc/rewrite is made with body {"type":"hitl_rewrite","session_id":"sess-abc","agent_id":"agent-1","new_content":"revised","operator_id":"operator-xander","timestamp":"2026-02-22T10:00:00Z"}
  Then the response status is 422
  And the response body is {"status":"error","reason":"missing_required_field: original_trace_id"}
  And HITLRelay is not called
```

### S2: Unknown command type returns 422
```gherkin
Scenario: HITL command with unknown type is rejected
  When a POST to /gateway/sessions/sess-abc/pause is made with body {"type":"hitl_override","session_id":"sess-abc","agent_id":"agent-1"}
  Then the response status is 422
  And the response body contains reason "unknown_command_type"
```

### S3: hitl_inject broadcasts immediately for Normal session
```gherkin
Scenario: hitl_inject for Normal session broadcasts synthetic message immediately
  Given session "sess-abc" is in Normal state
  And all required fields are present in the request body with prompt "stop and reconsider"
  When a POST to /gateway/sessions/sess-abc/inject is made
  Then the response status is 200
  And a synthetic DecisionLog containing "stop and reconsider" is broadcast on the session's DecisionLog PubSub topic immediately
  And no ETS buffer entry is created
```

## Acceptance Criteria
- [ ] `mix test test/observatory_web/controllers/gateway_controller_test.exs` passes a test that a `hitl_rewrite` POST missing `original_trace_id` returns HTTP 422 with reason `missing_required_field: original_trace_id` and does not call HITLRelay.
- [ ] `mix test test/observatory_web/controllers/gateway_controller_test.exs` passes a test that a POST with an unrecognized `type` field returns HTTP 422 with reason `unknown_command_type`.
- [ ] `mix test test/observatory/gateway/hitl_relay_test.exs` passes a test that `hitl_inject` for a `Normal` session broadcasts the synthetic message immediately without buffering.
- [ ] `mix compile --warnings-as-errors` passes.

## Data
**Inputs:** JSON request body with `type` and command-specific required fields
**Outputs:** HTTP 200 on success; HTTP 422 with reason on validation failure
**State changes:** None on validation failure; HITLRelay state and ETS updated only when validation passes.

## Traceability
- Parent FR: FR-11.4
- ADR: [ADR-021](../../decisions/ADR-021-hitl-intervention-api.md)
